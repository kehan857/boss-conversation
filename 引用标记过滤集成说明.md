# FastGPT引用标记过滤集成说明

## 问题描述

FastGPT在使用知识库时会在回复中插入引用标记，格式如：
```
市场空间广阔[686f252f6a67838a04c49415e](CITE)
```

这些技术性标记不应该在用户端显示，需要在前端进行过滤。

## 引用标记格式

### 1. 标准格式
```
[24位十六进制ID](CITE)
例如：[686f252f6a67838a04c49415e](CITE)
```

### 2. 可能的变体
```
[任意长度十六进制](CITE)
例如：[abc123def456](CITE)
```

## 解决方案

### 核心正则表达式

```javascript
// 24位十六进制标准格式
/\[([a-f0-9]{24})\]\(CITE\)/gi

// 通用格式（任意长度十六进制）
/\[([a-f0-9]+)\]\(CITE\)/gi
```

### 过滤器实现

```javascript
class CitationFilter {
    constructor() {
        this.patterns = {
            fastgptCitation: /\[([a-f0-9]{24})\]\(CITE\)/gi,
            generalCitation: /\[([a-f0-9]+)\]\(CITE\)/gi
        };
    }
    
    cleanFastGPTCitations(content) {
        if (!content || typeof content !== 'string') {
            return content;
        }
        
        return content
            .replace(/\[([a-f0-9]{24})\]\(CITE\)/gi, '')
            .replace(/\[([a-f0-9]+)\]\(CITE\)/gi, '')
            .trim();
    }
}
```

## 已修改的文件

### 1. wechat-test.html
- ✅ 集成了CitationFilter类
- ✅ 修改了processEmojiAndText函数
- ✅ 在内容显示前自动过滤引用标记

### 2. 营销智能体模拟微信测试页面.html
- ✅ 集成了CitationFilter类
- ✅ 修改了processEmojiAndText函数
- ✅ 在内容显示前自动过滤引用标记

### 3. 模拟识别V1.0_0608.html
- ✅ 集成了CitationFilter类
- ✅ 修改了processEmojiAndText函数
- ✅ 在内容显示前自动过滤引用标记

## 修改详情

### 原来的代码（错误）
```javascript
// 错误：将引用标记当作emoji处理
text = text.replace(/\[([a-f0-9]+)\]\(CITE\)/g, (match, emojiCode) => {
    // 试图将引用ID转换为emoji
    return '😊'; // 默认表情
});
```

### 修改后的代码（正确）
```javascript
// 正确：首先过滤引用标记
text = citationFilter.cleanFastGPTCitations(text);

// 然后处理真正的emoji（如果有的话）
text = text.replace(/\[([a-f0-9]+)\]/g, (match, emojiCode) => {
    // 处理真正的emoji代码
    return ''; // 不显示未知的代码
});
```

## 技术特点

### 1. 识别精确
- ✅ 精确匹配 `[十六进制](CITE)` 格式
- ✅ 支持24位标准格式和其他长度
- ✅ 不区分大小写（gi标志）

### 2. 处理安全
- ✅ 空值检查，避免错误
- ✅ 类型检查，确保是字符串
- ✅ trim()清理多余空白

### 3. 性能优化
- ✅ 一次性替换，避免多次遍历
- ✅ 轻量级实现，不影响性能
- ✅ 在现有流程中无缝集成

## 效果对比

### 修改前
```
用户看到：市场空间广阔[686f252f6a67838a04c49415e](CITE)，前景很好
```

### 修改后
```
用户看到：市场空间广阔，前景很好
```

## 使用说明

### 1. 自动过滤
所有经过 `processEmojiAndText` 函数处理的内容都会自动过滤引用标记。

### 2. 手动调用
如需在其他地方使用过滤功能：
```javascript
const cleanContent = citationFilter.cleanFastGPTCitations(rawContent);
```

### 3. 扩展支持
如果发现新的引用格式，只需在 `CitationFilter` 类中添加新的正则表达式即可。

## 测试验证

### 测试用例
```javascript
const testCases = [
    // 基础测试
    {
        input: "文本[686f252f6a67838a04c49415e](CITE)",
        expected: "文本"
    },
    // 多个引用
    {
        input: "开头[id1](CITE)中间[id2](CITE)结尾",
        expected: "开头中间结尾"
    },
    // 混合内容
    {
        input: "正常文本[ref](CITE)，继续文本",
        expected: "正常文本，继续文本"
    }
];
```

### 验证方法
1. 在浏览器控制台运行测试
2. 检查用户界面是否还显示引用标记
3. 确认正常文本内容不受影响

## 注意事项

1. **向后兼容**：修改保持了原有emoji处理逻辑
2. **性能影响**：过滤操作轻量级，性能影响可忽略
3. **扩展性**：可以轻松添加新的引用格式支持
4. **错误处理**：包含完善的输入验证和错误处理

## 总结

通过集成 `CitationFilter`，现在所有FastGPT的引用标记都会在用户端自动过滤，用户只会看到干净的文本内容，不会再看到形如 `[686f252f6a67838a04c49415e](CITE)` 的技术性标记。 