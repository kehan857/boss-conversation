{
  "name": "å¢å¼ºå›å¤2.0å·¥ä½œæµ",
  "type": "chatNode",
  "flowType": "chatFlow",
  "chatModuleId": "",
  "parentId": "",
  "showStatus": true,
  "position": {
    "x": 0,
    "y": 0
  },
  "tools": {
    "variables": []
  },
  "modules": [
    {
      "moduleId": "userChatInput",
      "name": "ç”¨æˆ·é—®é¢˜",
      "flowType": "questionInput",
      "position": {
        "x": 376.5126903553299,
        "y": 731.1645262146306
      },
      "inputs": [],
      "outputs": []
    },
    {
      "moduleId": "messageWaitingTool",
      "name": "æ¶ˆæ¯ç­‰å¾…å·¥å…·",
      "flowType": "runJs",
      "showStatus": true,
      "position": {
        "x": 780,
        "y": 730
      },
      "inputs": [
        {
          "key": "userMessage",
          "type": "input",
          "label": "ç”¨æˆ·æ¶ˆæ¯",
          "connected": true,
          "value": [
            "userChatInput",
            "userChatInput"
          ]
        },
        {
          "key": "messageHistory",
          "type": "input",
          "label": "æ¶ˆæ¯å†å²",
          "required": false,
          "valueType": "any",
          "connected": true,
          "value": [
            "messageWaitingTool",
            "messageHistory"
          ]
        },
        {
          "key": "messageCount",
          "type": "numberInput",
          "label": "æ¶ˆæ¯è®¡æ•°",
          "value": 0,
          "min": 0,
          "max": 100,
          "step": 1,
          "connected": true,
          "valueType": "numberInput",
          "description": "è®°å½•å½“å‰ç´¯ç§¯çš„æ¶ˆæ¯æ•°é‡",
          "required": false,
          "value": [
            "messageWaitingTool",
            "messageCount"
          ]
        },
        {
          "key": "messageThreshold",
          "type": "numberInput",
          "label": "æ¶ˆæ¯é˜ˆå€¼",
          "value": 3,
          "min": 1,
          "max": 10,
          "step": 1,
          "valueType": "numberInput",
          "description": "è§¦å‘å›å¤çš„æ¶ˆæ¯æ•°é‡é˜ˆå€¼",
          "required": false
        },
        {
          "key": "lastMessageTime",
          "type": "input",
          "label": "ä¸Šæ¬¡æ¶ˆæ¯æ—¶é—´",
          "value": "0",
          "valueType": "string",
          "description": "ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³",
          "required": false,
          "connected": true,
          "value": [
            "messageWaitingTool",
            "lastMessageTime"
          ]
        },
        {
          "key": "timeThreshold",
          "type": "numberInput",
          "label": "æ—¶é—´é˜ˆå€¼",
          "value": 2000,
          "min": 500,
          "max": 10000,
          "step": 500,
          "valueType": "numberInput",
          "description": "è§¦å‘å›å¤çš„æ—¶é—´é˜ˆå€¼(æ¯«ç§’)",
          "required": false
        },
        {
          "key": "dialogTurns",
          "type": "numberInput",
          "label": "å¯¹è¯è½®æ¬¡",
          "value": 0,
          "min": 0,
          "max": 1000,
          "step": 1,
          "valueType": "numberInput",
          "description": "å¯¹è¯è½®æ¬¡è®¡æ•°",
          "required": false,
          "connected": true,
          "value": [
            "messageWaitingTool",
            "dialogTurns"
          ]
        },
        {
          "key": "code",
          "type": "textArea",
          "label": "ä»£ç ",
          "valueType": "string",
          "description": "ç­‰å¾…å·¥å…·ä»£ç ",
          "value": "function main(inputs) {\n  // ç¡®ä¿è¾“å…¥å‚æ•°çš„ç±»å‹æ­£ç¡®\n  let {\n    userMessage,\n    messageHistory = [],\n    messageCount = 0,\n    messageThreshold = 3,\n    lastMessageTime = \"0\",\n    timeThreshold = 2000,\n    dialogTurns = 0\n  } = inputs;\n  \n  // è§£æå‚æ•°ï¼Œç¡®ä¿ç±»å‹æ­£ç¡®\n  let parsedMsgHistory = Array.isArray(messageHistory) ? [...messageHistory] : [];\n  const parsedLastTime = Number(lastMessageTime) || 0;\n  const parsedMsgCount = Number(messageCount) || 0;\n  const parsedTimeThreshold = Number(timeThreshold) || 2000;\n  const parsedMsgThreshold = Number(messageThreshold) || 3;\n  const parsedDialogTurns = Number(dialogTurns) || 0;\n  \n  // è®¡ç®—å½“å‰æ—¶é—´\n  const currentTime = Date.now();\n  const timeSinceLastMessageMs = currentTime - parsedLastTime;\n  \n  // åˆ¤æ–­æ˜¯å¦æ˜¯é¦–æ¬¡å¯¹è¯\n  const isFirstConversation = parsedLastTime === 0;\n  \n  // æ·»åŠ å½“å‰æ¶ˆæ¯åˆ°å†å²è®°å½•\n  if (userMessage) {\n    parsedMsgHistory.push(userMessage);\n  }\n  \n  // æ›´æ–°æ¶ˆæ¯è®¡æ•°\n  const updatedMsgCount = parsedMsgCount + 1;\n  \n  // åˆ¤æ–­è§¦å‘æ¡ä»¶\n  const timeCondition = timeSinceLastMessageMs > parsedTimeThreshold && parsedMsgHistory.length > 0;\n  const countCondition = updatedMsgCount >= parsedMsgThreshold;\n  \n  // ç¡®å®šæ˜¯å¦åº”è¯¥å›å¤\n  const shouldReplyByTime = timeCondition;\n  const shouldReplyByCount = countCondition;\n  const shouldReplyByFirstConversation = isFirstConversation;\n  \n  // æŒ‰æ¡ä»¶å†³å®šæ˜¯å¦åº”è¯¥å›å¤\n  const shouldReply = shouldReplyByTime || shouldReplyByCount || shouldReplyByFirstConversation;\n  \n  // æ˜¯å¦åº”è¯¥é˜»æ­¢å¯¹è¯\n  const shouldBlock = false;\n  \n  // å‡†å¤‡è°ƒè¯•ä¿¡æ¯\n  const debug = {\n    timeSinceLastMessageMs,\n    timeThresholdMs: parsedTimeThreshold,\n    parsedLastTimestamp: parsedLastTime,\n    currentTime,\n    isFirstConversation,\n    shouldReplyByTime,\n    shouldReplyByCount,\n    shouldReplyByFirstConversation,\n    messageHistoryLength: parsedMsgHistory.length,\n    inputUserMessage: userMessage,\n    parsedMsgHistory: JSON.stringify(parsedMsgHistory).slice(0, 500) + '...' // é˜²æ­¢è¿‡é•¿\n  };\n  \n  // å¦‚æœéœ€è¦å›å¤ï¼Œä¸”ä¸æ˜¯å› ä¸ºé¦–æ¬¡å¯¹è¯ï¼Œåˆ™æ¸…ç©ºæ¶ˆæ¯å†å²\n  let finalMessageHistory = parsedMsgHistory;\n  let finalMessageCount = updatedMsgCount;\n  \n  if ((shouldReplyByCount || shouldReplyByTime) && shouldReply) {\n    finalMessageHistory = [];\n    finalMessageCount = 0;\n  }\n  \n  // è¿”å›ç»“æœ\n  return {\n    userMessage,\n    shouldReply,\n    shouldBlock,\n    lastMessageTime: String(currentTime),\n    messageHistory: finalMessageHistory,\n    messageCount: finalMessageCount,\n    dialogTurns: parsedDialogTurns + 1,\n    debug\n  };\n}"
        }
      ],
      "outputs": [
        {
          "key": "shouldReply",
          "label": "æ˜¯å¦åº”ç­”",
          "description": "æ˜¯å¦åº”è¯¥å›å¤ç”¨æˆ·",
          "valueType": "boolean"
        },
        {
          "key": "shouldBlock",
          "label": "æ˜¯å¦é˜»æ­¢",
          "description": "æ˜¯å¦é˜»æ­¢å¯¹è¯ç»§ç»­",
          "valueType": "boolean"
        },
        {
          "key": "lastMessageTime",
          "label": "ä¸Šæ¬¡æ¶ˆæ¯æ—¶é—´",
          "description": "ä¸Šä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³",
          "valueType": "string"
        },
        {
          "key": "messageHistory",
          "label": "æ¶ˆæ¯å†å²",
          "description": "æ¶ˆæ¯å†å²è®°å½•",
          "valueType": "any"
        },
        {
          "key": "messageCount",
          "label": "æ¶ˆæ¯è®¡æ•°",
          "description": "å½“å‰ç´¯ç§¯çš„æ¶ˆæ¯æ•°é‡",
          "valueType": "number"
        },
        {
          "key": "dialogTurns",
          "label": "å¯¹è¯è½®æ¬¡",
          "description": "å¯¹è¯è½®æ¬¡è®¡æ•°",
          "valueType": "number"
        },
        {
          "key": "debug",
          "label": "è°ƒè¯•ä¿¡æ¯",
          "description": "è°ƒè¯•ç›¸å…³çš„ä¿¡æ¯",
          "valueType": "any"
        },
        {
          "key": "userMessage",
          "label": "ç”¨æˆ·æ¶ˆæ¯",
          "description": "å½“å‰ç”¨æˆ·æ¶ˆæ¯",
          "valueType": "string"
        }
      ]
    },
    {
      "moduleId": "conditionalRouter",
      "name": "æ¡ä»¶è·¯ç”±å™¨",
      "flowType": "conditionRouter",
      "showStatus": true,
      "position": {
        "x": 1170,
        "y": 730
      },
      "inputs": [
        {
          "key": "conditions",
          "type": "tableInput",
          "label": "åˆ†æ”¯æ¡ä»¶",
          "description": "æ¡ä»¶åˆ†æ”¯å®šä¹‰",
          "required": true,
          "valueType": "any",
          "value": [
            {
              "cond": [
                "messageWaitingTool",
                "shouldReply"
              ],
              "value": true,
              "desc": "éœ€è¦å›å¤"
            },
            {
              "cond": [
                "messageWaitingTool",
                "shouldReply"
              ],
              "value": false,
              "desc": "ä¸éœ€è¦å›å¤"
            }
          ]
        }
      ],
      "outputs": []
    },
    {
      "moduleId": "notifyFrontend",
      "name": "é€šçŸ¥å‰ç«¯ä¸å›å¤",
      "flowType": "runJs",
      "showStatus": true,
      "position": {
        "x": 1550,
        "y": 900
      },
      "inputs": [
        {
          "key": "code",
          "type": "textArea",
          "label": "ä»£ç ",
          "valueType": "string",
          "description": "é€šçŸ¥å‰ç«¯ä¸å›å¤çš„ä»£ç ",
          "value": "function main(inputs) {\n  return {\n    shouldReply: false,\n    responseText: \"\" // ç©ºå›å¤\n  };\n}"
        }
      ],
      "outputs": [
        {
          "key": "shouldReply",
          "label": "æ˜¯å¦å›å¤",
          "description": "æ˜¯å¦éœ€è¦å›å¤",
          "valueType": "boolean"
        },
        {
          "key": "responseText",
          "label": "å“åº”æ–‡æœ¬",
          "description": "å›å¤çš„æ–‡æœ¬å†…å®¹",
          "valueType": "string"
        }
      ]
    },
    {
      "moduleId": "modelChatNode",
      "name": "å¤§æ¨¡å‹å›å¤",
      "flowType": "chatNode",
      "showStatus": true,
      "position": {
        "x": 1550,
        "y": 620
      },
      "inputs": [
        {
          "key": "model",
          "type": "custom",
          "label": "æ¨¡å‹é€‰æ‹©",
          "description": "é€‰æ‹©è¦ä½¿ç”¨çš„æ¨¡å‹",
          "valueType": "string",
          "value": "gpt-3.5-turbo"
        },
        {
          "key": "temperature",
          "type": "slider",
          "label": "æ¸©åº¦",
          "min": 0,
          "max": 10,
          "step": 1,
          "valueType": "number",
          "value": 6
        },
        {
          "key": "maxToken",
          "type": "slider",
          "label": "å›å¤é•¿åº¦é™åˆ¶",
          "min": 100,
          "max": 4000,
          "step": 50,
          "valueType": "number",
          "value": 2000
        },
        {
          "key": "quoteTemplate",
          "type": "custom",
          "label": "å¼•ç”¨å†…å®¹æ¨¡æ¿",
          "description": "å¼•ç”¨å†…å®¹çš„æ¨¡æ¿",
          "valueType": "string",
          "value": ""
        },
        {
          "key": "quotePrompt",
          "type": "textArea",
          "label": "å¼•ç”¨å†…å®¹æç¤ºè¯",
          "description": "å¼•ç”¨å†…å®¹çš„æç¤ºè¯",
          "valueType": "string",
          "value": ""
        },
        {
          "key": "systemPrompt",
          "type": "textArea",
          "label": "ç³»ç»Ÿæç¤ºè¯",
          "description": "ç³»ç»Ÿæç¤ºè¯",
          "valueType": "string",
          "value": "ä½ æ˜¯ä¸€ä¸ªè¥é”€æ™ºèƒ½åŠ©æ‰‹ï¼Œæ“…é•¿å›ç­”ç”¨æˆ·å…³äºè¥é”€æ–¹é¢çš„é—®é¢˜ï¼Œæä¾›æœ‰ä»·å€¼çš„ä¿¡æ¯å’Œå»ºè®®ã€‚"
        },
        {
          "key": "history",
          "type": "custom",
          "label": "å†å²è®°å½•",
          "description": "èŠå¤©å†å²è®°å½•",
          "required": false,
          "valueType": "chatHistory",
          "connected": true,
          "value": [
            "messageWaitingTool",
            "messageHistory"
          ]
        },
        {
          "key": "quoteQA",
          "type": "custom",
          "label": "å¼•ç”¨å†…å®¹",
          "description": "éœ€è¦å¼•ç”¨çš„å†…å®¹",
          "required": false,
          "valueType": "datasetQuote",
          "value": []
        },
        {
          "key": "userChatInput",
          "type": "custom",
          "label": "ç”¨æˆ·é—®é¢˜",
          "required": true,
          "valueType": "string",
          "connected": true,
          "value": [
            "messageWaitingTool",
            "userMessage"
          ]
        }
      ],
      "outputs": [
        {
          "key": "answerText",
          "label": "å›å¤ç»“æœ",
          "description": "AIå›å¤çš„æ–‡æœ¬å†…å®¹",
          "valueType": "string"
        },
        {
          "key": "userChatInput",
          "label": "ç”¨æˆ·é—®é¢˜",
          "description": "ç”¨æˆ·æé—®çš„å†…å®¹",
          "valueType": "string"
        }
      ]
    },
    {
      "moduleId": "enhancedResponseNode",
      "name": "å¢å¼ºå›å¤åˆ†æ®µå™¨",
      "flowType": "runJs",
      "showStatus": true,
      "position": {
        "x": 1900,
        "y": 620
      },
      "inputs": [
        {
          "key": "inputText",
          "type": "input",
          "label": "è¾“å…¥æ–‡æœ¬",
          "description": "éœ€è¦å¤„ç†çš„åŸå§‹æ–‡æœ¬",
          "required": true,
          "valueType": "string",
          "connected": true,
          "value": [
            "modelChatNode",
            "answerText"
          ]
        },
        {
          "key": "segmentLength",
          "type": "numberInput",
          "label": "åˆ†æ®µé•¿åº¦",
          "value": 50,
          "min": 10,
          "max": 200,
          "step": 10,
          "valueType": "numberInput",
          "description": "æ¯æ®µæ–‡æœ¬çš„æœ€å¤§å­—ç¬¦æ•°",
          "required": false
        },
        {
          "key": "accumulatedDelay",
          "type": "numberInput",
          "label": "å»¶è¿Ÿæ—¶é—´",
          "value": 2000,
          "min": 500,
          "max": 5000,
          "step": 500,
          "valueType": "numberInput",
          "description": "æ¯æ®µæ˜¾ç¤ºçš„å»¶è¿Ÿæ—¶é—´(æ¯«ç§’)",
          "required": false
        },
        {
          "key": "code",
          "type": "textArea",
          "label": "ä»£ç ",
          "valueType": "string",
          "description": "å¢å¼ºå›å¤åˆ†æ®µå™¨ä»£ç ",
          "value": "async function main(inputs) {\n  // è§£æè¾“å…¥å‚æ•°\n  const { inputText, accumulatedDelay = 2000, segmentLength = 150 } = inputs;\n  \n  // å¤„ç†è¾“å…¥å¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–æ•°ç»„çš„æƒ…å†µ\n  let textToProcess = inputText;\n  \n  // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„\n  if (!textToProcess) {\n    return {\n      outputText: [],\n      accumulatedDelay: accumulatedDelay\n    };\n  }\n  \n  // å¦‚æœè¾“å…¥å·²ç»æ˜¯æ•°ç»„ï¼Œåˆ™ç›´æ¥ä½¿ç”¨\n  if (Array.isArray(textToProcess)) {\n    return {\n      outputText: textToProcess,\n      accumulatedDelay: accumulatedDelay\n    };\n  }\n  \n  // å¦‚æœè¾“å…¥æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ†æ®µå¤„ç†\n  function segmentText(text, maxLength) {\n    if (!text || text.length <= maxLength) {\n      return [text];\n    }\n    \n    const segments = [];\n    let currentSegment = '';\n    \n    // æŒ‰å¥å­åˆ†å‰²ï¼Œä¿ç•™åˆ†éš”ç¬¦\n    const sentences = text.split(/([ã€‚ï¼ï¼Ÿ.!?])/g);\n    \n    for (let i = 0; i < sentences.length; i += 2) {\n      const sentence = sentences[i] + (sentences[i + 1] || '');\n      \n      // å¦‚æœå½“å‰æ®µè½åŠ ä¸Šæ–°å¥å­ä¼šè¶…å‡ºæœ€å¤§é•¿åº¦ï¼Œåˆ›å»ºæ–°æ®µè½\n      if (currentSegment.length + sentence.length > maxLength && currentSegment.length > 0) {\n        segments.push(currentSegment);\n        currentSegment = sentence;\n      } else {\n        currentSegment += sentence;\n      }\n    }\n    \n    // æ·»åŠ æœ€åä¸€æ®µ\n    if (currentSegment.length > 0) {\n      segments.push(currentSegment);\n    }\n    \n    return segments;\n  }\n  \n  // æ·»åŠ è¡¨æƒ…å’Œæ ¼å¼åŒ–\n  function formatText(segments) {\n    const emojis = ['ğŸ˜Š', 'ğŸ‘', 'âœ¨', 'ğŸ”', 'ğŸ“', 'ğŸ’¡', 'ğŸŒŸ', 'ğŸ“Š', 'ğŸ¯', 'ğŸš€'];\n    \n    return segments.map((segment, index) => {\n      // éšæœºé€‰æ‹©è¡¨æƒ…\n      const emoji = emojis[Math.floor(Math.random() * emojis.length)];\n      \n      // ä¸ºæ¯æ®µæ·»åŠ è¡¨æƒ…å‰ç¼€\n      return `${emoji} ${segment}`;\n    });\n  }\n  \n  // æ‰§è¡Œåˆ†æ®µå’Œæ ¼å¼åŒ–\n  const segments = segmentText(textToProcess, segmentLength);\n  const formattedSegments = formatText(segments);\n  \n  // è¿”å›å¤„ç†ç»“æœ\n  return {\n    outputText: formattedSegments,\n    accumulatedDelay: accumulatedDelay\n  };\n}"
        }
      ],
      "outputs": [
        {
          "key": "outputText",
          "label": "è¾“å‡ºæ–‡æœ¬",
          "description": "åˆ†æ®µåçš„æ–‡æœ¬æ•°ç»„",
          "valueType": "arrayString"
        },
        {
          "key": "accumulatedDelay",
          "label": "å»¶è¿Ÿæ—¶é—´",
          "description": "æ¯æ®µæ˜¾ç¤ºçš„å»¶è¿Ÿæ—¶é—´(æ¯«ç§’)",
          "valueType": "number"
        }
      ]
    },
    {
      "moduleId": "chatOutput",
      "name": "å¯¹è¯è¾“å‡º",
      "flowType": "chatOutput",
      "showStatus": true,
      "position": {
        "x": 2300,
        "y": 730
      },
      "inputs": [
        {
          "key": "output",
          "type": "custom",
          "label": "å›å¤å†…å®¹",
          "description": "è¾“å‡ºåˆ°å¯¹è¯æ¡†çš„å†…å®¹",
          "required": true,
          "valueType": "string",
          "connected": true,
          "value": [
            "enhancedResponseNode",
            "outputText"
          ]
        },
        {
          "key": "delay",
          "type": "numberInput",
          "label": "è¾“å‡ºå»¶è¿Ÿ",
          "min": 0,
          "max": 10000,
          "step": 100,
          "value": 0,
          "valueType": "number",
          "description": "å»¶è¿Ÿè¾“å‡ºçš„æ—¶é—´(æ¯«ç§’)",
          "connected": true,
          "value": [
            "enhancedResponseNode",
            "accumulatedDelay"
          ]
        },
        {
          "key": "shouldReply",
          "type": "switch",
          "label": "æ˜¯å¦å›å¤",
          "value": true,
          "valueType": "boolean",
          "description": "æ˜¯å¦åº”è¯¥å›å¤(falseåˆ™ä¸æ˜¾ç¤ºå›å¤)",
          "connected": true,
          "value": [
            "messageWaitingTool",
            "shouldReply"
          ]
        }
      ],
      "outputs": []
    }
  ],
  "edges": [
    {
      "source": "userChatInput",
      "target": "messageWaitingTool",
      "sourceHandle": "userChatInput",
      "targetHandle": "userMessage"
    },
    {
      "source": "messageWaitingTool",
      "target": "messageWaitingTool",
      "sourceHandle": "messageHistory",
      "targetHandle": "messageHistory"
    },
    {
      "source": "messageWaitingTool",
      "target": "messageWaitingTool",
      "sourceHandle": "messageCount",
      "targetHandle": "messageCount"
    },
    {
      "source": "messageWaitingTool",
      "target": "messageWaitingTool",
      "sourceHandle": "lastMessageTime",
      "targetHandle": "lastMessageTime"
    },
    {
      "source": "messageWaitingTool",
      "target": "messageWaitingTool",
      "sourceHandle": "dialogTurns",
      "targetHandle": "dialogTurns"
    },
    {
      "source": "messageWaitingTool",
      "target": "conditionalRouter",
      "sourceHandle": "shouldReply",
      "targetHandle": "conditions"
    },
    {
      "source": "conditionalRouter",
      "target": "modelChatNode",
      "sourceHandle": "éœ€è¦å›å¤",
      "targetHandle": null
    },
    {
      "source": "conditionalRouter",
      "target": "notifyFrontend",
      "sourceHandle": "ä¸éœ€è¦å›å¤",
      "targetHandle": null
    },
    {
      "source": "messageWaitingTool",
      "target": "modelChatNode",
      "sourceHandle": "messageHistory",
      "targetHandle": "history"
    },
    {
      "source": "messageWaitingTool",
      "target": "modelChatNode",
      "sourceHandle": "userMessage",
      "targetHandle": "userChatInput"
    },
    {
      "source": "modelChatNode",
      "target": "enhancedResponseNode",
      "sourceHandle": "answerText",
      "targetHandle": "inputText"
    },
    {
      "source": "enhancedResponseNode",
      "target": "chatOutput",
      "sourceHandle": "outputText",
      "targetHandle": "output"
    },
    {
      "source": "enhancedResponseNode",
      "target": "chatOutput",
      "sourceHandle": "accumulatedDelay",
      "targetHandle": "delay"
    },
    {
      "source": "messageWaitingTool",
      "target": "chatOutput",
      "sourceHandle": "shouldReply",
      "targetHandle": "shouldReply"
    }
  ]
} 