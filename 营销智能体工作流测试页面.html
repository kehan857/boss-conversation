<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥é”€æ™ºèƒ½ä½“å·¥ä½œæµæµ‹è¯•</title>
    <style>
        :root {
            --primary-color: #1890ff;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #f5222d;
            --text-color: #333;
            --light-bg: #f5f5f5;
            --border-color: #e8e8e8;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            color: var(--text-color);
            line-height: 1.6;
            background-color: var(--light-bg);
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        main {
            padding: 20px;
        }
        
        .panel {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 12px 15px;
            background-color: #f0f0f0;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-body {
            padding: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #40a9ff;
        }
        
        button:disabled {
            background-color: #d9d9d9;
            cursor: not-allowed;
        }
        
        /* å¾®ä¿¡é£æ ¼èŠå¤©ç•Œé¢ */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            background-color: #ebebeb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .message {
            margin-bottom: 10px;
            max-width: 70%;
            padding: 0;
            display: flex;
        }
        
        .message-user {
            margin-left: auto;
            flex-direction: row-reverse;
        }
        
        .message-ai {
            margin-right: auto;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            background-color: #ccc;
            margin: 0 8px;
            flex-shrink: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-content {
            background-color: white;
            padding: 10px 12px;
            border-radius: 4px;
            position: relative;
            font-family: 'PingFang SC', 'Microsoft YaHei', 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
            unicode-bidi: isolate;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .message-user .message-content {
            background-color: #9EEB62;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            background-color: #f5f5f5;
            border-top: 1px solid #e0e0e0;
        }
        
        .chat-input input {
            flex: 1;
            margin-right: 10px;
        }
        
        .typing-indicator {
            display: none !important;
        }
        
        .typing-indicator span {
            display: none !important;
        }
        
        @keyframes typing {
            0% { opacity: 0; }
            100% { opacity: 0; }
        }
        
        /* æ—¥å¿—å’Œè°ƒè¯•åŒºåŸŸ */
        .log-container {
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
        }
        
        .log-entry {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        
        .log-time {
            color: #888;
        }
        
        .log-info {
            color: var(--primary-color);
        }
        
        .log-warning {
            color: var(--warning-color);
        }
        
        .log-error {
            color: var(--error-color);
        }
        
        .log-success {
            color: var(--success-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>è¥é”€æ™ºèƒ½ä½“å·¥ä½œæµæµ‹è¯•</h1>
            <div class="subtitle">æµ‹è¯•å¤šæ¶ˆæ¯æ±‡æ€»å’Œåˆ†æ®µå›å¤åŠŸèƒ½ v2.12 - å¢å¼ºisTimeUpè°ƒè¯•</div>
        </header>
        
        <main>
            <div class="panel">
                <div class="panel-header">
                    <span>APIé…ç½®</span>
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <label for="apiKey">APIå¯†é’¥</label>
                        <input type="text" id="apiKey" value="fastgpt-o1RLNv6G3Bz6d3dm7nLaH4liAexaTKX0MiWxJMsveKgeN6UzcbWfsevL">
                    </div>
                    <div class="form-group">
                        <label for="apiUrl">APIåœ°å€</label>
                        <input type="text" id="apiUrl" value="https://api.fastgpt.in/api">
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>å¾®ä¿¡æ¨¡æ‹ŸèŠå¤©</span>
                    <button id="clearChatBtn">æ¸…ç©ºèŠå¤©</button>
                </div>
                <div class="panel-body">
                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages">
                            <div class="message message-ai">
                                <div class="avatar">AI</div>
                                <div class="message-content">
                                    æ‚¨å¥½ï¼Œæˆ‘æ˜¯**é›†å›¢é¡¾é—®ï¼Œè¯·é—®æ‚¨æœ€è¿‘å…³æ³¨çš„é¡¹ç›®æ˜¯ä»€ä¹ˆï¼Ÿ
                                </div>
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="userInput" placeholder="è¾“å…¥æ¶ˆæ¯..." />
                            <button id="sendButton">å‘é€</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>æ—¥å¿—</span>
                    <button id="clearLogsBtn">æ¸…ç©ºæ—¥å¿—</button>
                </div>
                <div class="panel-body">
                    <div id="logContainer" class="log-container"></div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>è°ƒè¯•ä¿¡æ¯</span>
                    <button id="toggleDebugBtn">æ˜¾ç¤º/éšè—</button>
                </div>
                <div class="panel-body" id="debugPanel" style="display: none;">
                    <div class="form-group">
                        <label>è¯·æ±‚å†…å®¹</label>
                        <pre id="requestDebug" style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto; max-height: 150px; font-size: 12px;"></pre>
                    </div>
                    <div class="form-group">
                        <label>å“åº”å†…å®¹</label>
                        <pre id="responseDebug" style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto; max-height: 150px; font-size: 12px;"></pre>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOMå…ƒç´ 
            const apiKeyInput = document.getElementById('apiKey');
            const apiUrlInput = document.getElementById('apiUrl');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const chatMessages = document.getElementById('chatMessages');
            const clearChatBtn = document.getElementById('clearChatBtn');
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            const toggleDebugBtn = document.getElementById('toggleDebugBtn');
            const debugPanel = document.getElementById('debugPanel');
            const logContainer = document.getElementById('logContainer');
            const requestDebug = document.getElementById('requestDebug');
            const responseDebug = document.getElementById('responseDebug');
            
            // å…¨å±€å˜é‡
            let messageHistory = [];
            let lastMessageTime = 0; // ä¿®å¤ï¼šåˆå§‹å€¼è®¾ä¸º0ï¼Œè¡¨ç¤ºé¦–æ¬¡å¯¹è¯
            let messageCount = 0;
            let waitingForResponse = false;
            let timeoutTimer = null;
            let currentReadTime = null; // é˜…è¯»æ—¶é—´ï¼Œå¿…é¡»ä»APIå“åº”ä¸­è·å–ï¼Œä¸å…è®¸é»˜è®¤å€¼
            let isReading = false; // æ ‡è®°AIæ˜¯å¦æ­£åœ¨é˜…è¯»
            let readingStartTime = null; // å¼€å§‹é˜…è¯»çš„æ—¶é—´
            let hasReceivedResponse = false; // æ ‡è®°æ˜¯å¦å·²æ”¶åˆ°ç¬¬ä¸€æ¬¡å“åº”
            let isSecondRequest = false; // æ ‡è®°æ˜¯å¦ä¸ºç¬¬äºŒæ¬¡è¯·æ±‚
            let chatSessionId = 'session_' + Date.now(); // æ–°å¢ï¼šä¼šè¯ID
            let isPreparingSecondRequest = false; // æ–°å¢ï¼šæ ‡è®°æ˜¯å¦æ­£åœ¨å‡†å¤‡ç¬¬äºŒæ¬¡è¯·æ±‚
            
            // äº‹ä»¶ç›‘å¬å™¨
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            sendButton.addEventListener('click', sendMessage);
            
            clearChatBtn.addEventListener('click', function() {
                chatMessages.innerHTML = '';
                addLog('ğŸ—‘ï¸ èŠå¤©è®°å½•å·²æ¸…ç©º', 'info');
                // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                addMessage('AI', 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯è¥é”€æ™ºèƒ½ä½“ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ');
                
                // ğŸ” ç›‘æ§æ¸…ç©ºèŠå¤©å‰çš„lastTimeå€¼
                addLog(`ğŸ” [ç›‘æ§] æ¸…ç©ºèŠå¤©å‰lastTime: ${lastMessageTime}`, 'info');
                
                // é‡ç½®çŠ¶æ€
                messageHistory = [];
                lastMessageTime = 0; // ä¿®å¤ï¼šé‡ç½®ä¸º0
                messageCount = 0;
                isReading = false;
                hasReceivedResponse = false;
                isSecondRequest = false;
                isPreparingSecondRequest = false; // é‡ç½®å‡†å¤‡æ ‡è®°
                currentReadTime = null; // ğŸ”§ æ–°å¢ï¼šé‡ç½®é˜…è¯»æ—¶é—´ï¼Œè¦æ±‚é‡æ–°ä»APIè·å–
                if (timeoutTimer) {
                    clearTimeout(timeoutTimer);
                    timeoutTimer = null;
                }
                
                // ğŸ” ç›‘æ§æ¸…ç©ºèŠå¤©åçš„lastTimeå€¼
                addLog(`ğŸ” [ç›‘æ§] æ¸…ç©ºèŠå¤©ålastTime: ${lastMessageTime}`, 'info');
                addLog(`ğŸ”„ ç³»ç»ŸçŠ¶æ€å·²é‡ç½®ï¼Œread_timeå°†ä»ä¸‹æ¬¡APIè¯·æ±‚ä¸­é‡æ–°è·å–`, 'info');
            });
            
            clearLogsBtn.addEventListener('click', function() {
                logContainer.innerHTML = '';
                addLog('ğŸ§¹ æ—¥å¿—å·²æ¸…ç©º', 'info');
            });
            
            toggleDebugBtn.addEventListener('click', function() {
                debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
            });
            
            // å‘é€æ¶ˆæ¯å‡½æ•°
            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;
                
                // ğŸ”¥ v2.8ç®€åŒ–é€»è¾‘ - åŸºç¡€åŒè¯·æ±‚æœºåˆ¶
                addLog(`ğŸ”¥ [v2.8] åŸºç¡€åŒè¯·æ±‚æœºåˆ¶å¯åŠ¨`, 'success');
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                userInput.value = '';
                
                // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
                addMessage('ç”¨æˆ·', message);
                
                // è®°å½•æœ¬æ¬¡æ¶ˆæ¯æ—¶é—´
                const currentMessageTime = Date.now();
                
                // æ›´æ–°æ¶ˆæ¯è®¡æ•°
                messageCount++;
                
                // æ·»åŠ åˆ°å†å²è®°å½•
                messageHistory.push(message);
                
                // è®°å½•å½“å‰çŠ¶æ€
                addLog(`ğŸ“ æ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯: "${message}"`, 'info');
                addLog(`ğŸ“Š å½“å‰çŠ¶æ€: æ¶ˆæ¯æ•°=${messageCount}`, 'info');
                
                // å¦‚æœå½“å‰æ­£åœ¨ç­‰å¾…å“åº”ï¼Œä¸å¯åŠ¨æ–°è¯·æ±‚
                if (waitingForResponse) {
                    addLog('â³ æ™ºèƒ½ä½“æ­£åœ¨å¤„ç†ä¸­ï¼Œæš‚ä¸å¯åŠ¨æ–°çš„è¯·æ±‚', 'warning');
                    return;
                }
                
                // é‡ç½®çŠ¶æ€
                hasReceivedResponse = false;
                isSecondRequest = false;
                
                addLog(`ğŸ”„ é‡ç½®è¯·æ±‚çŠ¶æ€`, 'info');
                
                // âœ… ç«‹å³å‘é€ç¬¬ä¸€æ¬¡APIè¯·æ±‚
                addLog(`ğŸš€ ç«‹å³å‘é€ç¬¬ä¸€æ¬¡APIè¯·æ±‚`, 'success');
                processMessages(false); // falseè¡¨ç¤ºç¬¬ä¸€æ¬¡è¯·æ±‚
            }
            
            // å¤„ç†æ¶ˆæ¯å¹¶å‘é€åˆ°API
            async function processMessages(isSecond = false) {
                // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œç›´æ¥è¿”å›
                if (messageHistory.length === 0) {
                    addLog('âŒ æ²¡æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†', 'warning');
                    return;
                }
                
                const requestType = isSecond ? 'ç¬¬äºŒæ¬¡' : 'ç¬¬ä¸€æ¬¡';
                
                // ğŸ”§ æ–°å¢ï¼šå¦‚æœæ˜¯ç¬¬äºŒæ¬¡è¯·æ±‚ï¼Œé‡ç½®å‡†å¤‡æ ‡è®°
                if (isSecond) {
                    isPreparingSecondRequest = false;
                    addLog(`ğŸ”„ ç¬¬äºŒæ¬¡è¯·æ±‚å¼€å§‹ï¼Œé‡ç½®å‡†å¤‡æ ‡è®°`, 'info');
                }
                
                // ğŸ”’ å¼ºåŒ–é˜²é‡å¤æ£€æŸ¥
                if (isSecond) {
                    if (hasReceivedResponse) {
                        addLog('ğŸ›‘ ç¬¬ä¸€æ¬¡è¯·æ±‚å·²å®Œæˆä¸”isTimeUpä¸ºtrueï¼Œç›´æ¥è·³è¿‡ç¬¬äºŒæ¬¡è¯·æ±‚', 'warning');
                    return;
                    }
                    if (waitingForResponse && !isSecondRequest) {
                        addLog('ğŸ›‘ ç¬¬ä¸€æ¬¡è¯·æ±‚ä»åœ¨å¤„ç†ï¼Œç›´æ¥è·³è¿‡ç¬¬äºŒæ¬¡è¯·æ±‚', 'warning');
                        return;
                    }
                }
                
                waitingForResponse = true;
                addLog(`ğŸ¤– å¼€å§‹${requestType}æ™ºèƒ½å¤„ç† ${messageHistory.length} æ¡æ¶ˆæ¯...`, 'info');
                
                try {
                    // å‡†å¤‡APIè¯·æ±‚
                    const apiKey = apiKeyInput.value.trim();
                    const apiUrl = apiUrlInput.value.trim();
                    
                    if (!apiKey || !apiUrl) {
                        throw new Error('APIå¯†é’¥æˆ–åœ°å€ä¸èƒ½ä¸ºç©º');
                    }
                    
                    // æ„å»ºè¯·æ±‚ä½“
                    const requestBody = {
                        chatId: chatSessionId, // ä½¿ç”¨å›ºå®šçš„ä¼šè¯ID
                        stream: false,
                        detail: true,
                        variables: {
                            lastMessageTime: lastMessageTime,
                            messageCount: messageCount,
                            messageHistory: messageHistory,
                            read_time: currentReadTime,
                            isSecondRequest: isSecond,
                            hasReceivedResponse: hasReceivedResponse
                        },
                        messages: [{
                            role: "user",
                            content: messageHistory.join("\n")
                        }]
                    };
                    
                    // ğŸ” ç›‘æ§å‘é€ç»™APIçš„lastTimeå€¼
                    addLog(`ğŸ” [ç›‘æ§] å‘é€ç»™APIçš„lastMessageTime: ${lastMessageTime}`, 'info');
                    
                    // æ˜¾ç¤ºè¯·æ±‚å†…å®¹
                    requestDebug.textContent = JSON.stringify(requestBody, null, 2);
                    
                    addLog(`ğŸŒ å‘é€${requestType}APIè¯·æ±‚: ${apiUrl}`, 'info');
                    
                    // å‘é€è¯·æ±‚
                    const response = await fetch(`${apiUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`APIè¯·æ±‚å¤±è´¥(${response.status}): ${errorText}`);
                    }
                    
                    // è§£æå“åº”
                    const responseData = await response.json();
                    
                    // æ˜¾ç¤ºå“åº”å†…å®¹
                    responseDebug.textContent = JSON.stringify(responseData, null, 2);
                    
                    addLog(`âœ… ${requestType}APIå“åº”æˆåŠŸï¼Œå¼€å§‹å¤„ç†å›å¤å†…å®¹`, 'success');
                    
                    // ğŸ” æ·»åŠ æ˜æ˜¾çš„APIå“åº”ç›‘æ§
                    addLog(`ğŸ” [ç›‘æ§] ğŸš¨ APIå“åº”å¤„ç†å¼€å§‹ ğŸš¨`, 'success');
                    addLog(`ğŸ” [ç›‘æ§] å“åº”æ•°æ®ç±»å‹: ${typeof responseData}`, 'info');
                    addLog(`ğŸ” [ç›‘æ§] æ˜¯å¦æœ‰responseData: ${!!responseData}`, 'info');
                    addLog(`ğŸ” [ç›‘æ§] æ˜¯å¦æœ‰responseData.responseData: ${!!responseData.responseData}`, 'info');
                    
                    // å¤„ç†å“åº”
                    handleResponse(responseData, requestType);
                    
                } catch (error) {
                    addLog(`âŒ ${requestType}è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
                    console.error('APIè¯·æ±‚é”™è¯¯:', error);
                    
                    // ğŸ”§ é”™è¯¯æ—¶ä¸æ˜¾ç¤ºå›å¤æ¶ˆæ¯ï¼Œä»…è®°å½•æ—¥å¿—
                    addLog(`âš ï¸ ${requestType}è¯·æ±‚å¤±è´¥ï¼Œä¸æ˜¾ç¤ºé”™è¯¯å›å¤`, 'warning');
                    
                } finally {
                    // ğŸ” ç›‘æ§finallyå—å¼€å§‹æ—¶çš„lastTimeå€¼
                    addLog(`ğŸ” [ç›‘æ§] finallyå—å¼€å§‹ï¼ŒlastTime: ${lastMessageTime}`, 'info');
                    
                    // é‡ç½®çŠ¶æ€
                    waitingForResponse = false;
                    
                    // ğŸ”§ ä¼˜åŒ–çŠ¶æ€é‡ç½®é€»è¾‘
                    if (!isSecond) {
                        // ğŸ”§ ä¿®å¤ï¼šåªæœ‰åœ¨ç¡®å®šä¸éœ€è¦ç»§ç»­ç­‰å¾…æ—¶æ‰åœæ­¢å€’è®¡æ—¶
                        if (hasReceivedResponse) {
                            // ç¬¬ä¸€æ¬¡è¯·æ±‚å®Œæˆä¸”isTimeUp=trueï¼Œåœæ­¢å€’è®¡æ—¶
                            isReading = false;
                            addLog(`ğŸ”„ ç¬¬ä¸€æ¬¡è¯·æ±‚å®Œæˆä¸”æ— éœ€ç¬¬äºŒæ¬¡è¯·æ±‚ï¼Œæ¸…ç†å®šæ—¶å™¨çŠ¶æ€`, 'info');
                        } else {
                            // ç¬¬ä¸€æ¬¡è¯·æ±‚å®Œæˆä½†isTimeUp=falseï¼Œä¿æŒå€’è®¡æ—¶ç»§ç»­
                            addLog(`ğŸ”„ ç¬¬ä¸€æ¬¡è¯·æ±‚å®Œæˆä½†éœ€è¦ç­‰å¾…ç¬¬äºŒæ¬¡è¯·æ±‚ï¼Œä¿æŒå€’è®¡æ—¶çŠ¶æ€`, 'info');
                            addLog(`ğŸ” [ç›‘æ§] timeoutTimerçŠ¶æ€: ${timeoutTimer ? 'è¿è¡Œä¸­' : 'å·²æ¸…é™¤'}`, 'info');
                            addLog(`ğŸ” [ç›‘æ§] isReadingçŠ¶æ€: ${isReading}`, 'info');
                            addLog(`ğŸ” [ç›‘æ§] readingStartTime: ${readingStartTime}`, 'info');
                        }
                    }
                    
                    // ğŸ”§ ä¿®å¤ï¼šåªæœ‰åœ¨ç¡®å®šä¸éœ€è¦ç¬¬äºŒæ¬¡è¯·æ±‚æ—¶æ‰æ¸…ç©ºæ¶ˆæ¯å†å²
                    const shouldClearHistory = isSecond || // ç¬¬äºŒæ¬¡è¯·æ±‚å®Œæˆ
                                             hasReceivedResponse || // ç¬¬ä¸€æ¬¡è¯·æ±‚å®Œæˆä¸”isTimeUp=true
                                             (!isSecond && timeoutTimer === null && !isReading && !isPreparingSecondRequest); // ç¬¬ä¸€æ¬¡è¯·æ±‚å®Œæˆä¸”å®šæ—¶å™¨å·²æ¸…é™¤ä¸”ä¸åœ¨é˜…è¯»çŠ¶æ€ä¸”ä¸åœ¨å‡†å¤‡ç¬¬äºŒæ¬¡è¯·æ±‚
                    
                    if (shouldClearHistory) {
                        messageCount = 0;
                        messageHistory = [];
                        addLog(`ğŸ”„ ${requestType}è¯·æ±‚å®Œæˆï¼ŒçŠ¶æ€é‡ç½®ï¼ˆæ¸…ç©ºæ¶ˆæ¯å†å²ï¼‰`, 'info');
                    } else {
                        addLog(`ğŸ”„ ${requestType}è¯·æ±‚å®Œæˆï¼Œä¿ç•™æ¶ˆæ¯å†å²ä¾›ç¬¬äºŒæ¬¡è¯·æ±‚ä½¿ç”¨`, 'info');
                        if (isPreparingSecondRequest) {
                            addLog(`ğŸš€ æ£€æµ‹åˆ°æ­£åœ¨å‡†å¤‡ç¬¬äºŒæ¬¡è¯·æ±‚ï¼Œä¿ç•™æ¶ˆæ¯å†å²`, 'info');
                        }
                    }
                    
                    // ğŸ” ç›‘æ§finallyå—ç»“æŸæ—¶çš„lastTimeå€¼
                    addLog(`ğŸ” [ç›‘æ§] finallyå—ç»“æŸï¼ŒlastTime: ${lastMessageTime}`, 'info');
                }
            }
            
            // ğŸ”§ æ–°å¢ï¼šæå–å¹¶æ›´æ–°lastTimeçš„ä¸“ç”¨å‡½æ•°
            function extractAndUpdateLastTime(responseData) {
                // ğŸ” è®°å½•å‡½æ•°è°ƒç”¨å’Œå½“å‰å€¼
                addLog(`ğŸ” [ç›‘æ§] extractAndUpdateLastTimeè¢«è°ƒç”¨ï¼Œå½“å‰lastTime: ${lastMessageTime}`, 'info');
                
                try {
                    // æ–¹æ³•1ï¼šä»newVariablesä¸­æå–lastTime/lastMessageTime
                    if (responseData.newVariables) {
                        addLog(`ğŸ” [ç›‘æ§] æ£€æŸ¥newVariables: ${JSON.stringify(responseData.newVariables)}`, 'info');
                        
                        if (responseData.newVariables.lastTime) {
                            const newLastTime = parseInt(responseData.newVariables.lastTime);
                            if (newLastTime > 0) {
                                const oldValue = lastMessageTime;
                                lastMessageTime = newLastTime;
                                addLog(`ğŸ• ä»newVariables.lastTimeæ›´æ–°å…¨å±€å˜é‡: ${oldValue} â†’ ${lastMessageTime}`, 'success');
                                return;
                            }
                        }
                        
                        if (responseData.newVariables.lastMessageTime) {
                            const newLastTime = parseInt(responseData.newVariables.lastMessageTime);
                            if (newLastTime > 0) {
                                const oldValue = lastMessageTime;
                                lastMessageTime = newLastTime;
                                addLog(`ğŸ• ä»newVariables.lastMessageTimeæ›´æ–°å…¨å±€å˜é‡: ${oldValue} â†’ ${lastMessageTime}`, 'success');
                    return;
                            }
                        }
                }

                    // æ–¹æ³•2ï¼šä»responseDataèŠ‚ç‚¹ä¸­æŸ¥æ‰¾æ—¶é—´æˆ³ç”ŸæˆèŠ‚ç‚¹
                if (Array.isArray(responseData.responseData)) {
                        addLog(`ğŸ” [ç›‘æ§] éå†${responseData.responseData.length}ä¸ªå“åº”èŠ‚ç‚¹`, 'info');
                        
                        for (const node of responseData.responseData) {
                            // ğŸ” è¯¦ç»†è®°å½•æ¯ä¸ªèŠ‚ç‚¹ä¿¡æ¯
                            addLog(`ğŸ” [ç›‘æ§] æ£€æŸ¥èŠ‚ç‚¹: ${node.moduleName || 'æœªçŸ¥'} (${node.moduleType || 'æœªçŸ¥ç±»å‹'})`, 'info');
                            
                            // æŸ¥æ‰¾ä»£ç è¿è¡ŒèŠ‚ç‚¹çš„æ—¶é—´æˆ³è¾“å‡º
                            if (node && node.customOutputs) {
                                addLog(`ğŸ” [ç›‘æ§] å‘ç°customOutputs: ${JSON.stringify(node.customOutputs)}`, 'info');
                                
                                // ä¼˜å…ˆæŸ¥æ‰¾currentTimeï¼ˆæ ¹æ®æˆªå›¾æ˜¾ç¤ºï¼‰
                                if (node.customOutputs.currentTime) {
                                    const newLastTime = parseInt(node.customOutputs.currentTime);
                                    addLog(`ğŸ” [ç›‘æ§] æ‰¾åˆ°currentTime: ${newLastTime}`, 'info');
                                    if (newLastTime > 0) {
                                        const oldValue = lastMessageTime;
                                        lastMessageTime = newLastTime;
                                        addLog(`ğŸ• âœ… ä»${node.moduleName || 'èŠ‚ç‚¹'}çš„customOutputs.currentTimeæ›´æ–°å…¨å±€å˜é‡: ${oldValue} â†’ ${lastMessageTime}`, 'success');
                                        return;
                                    }
                                }
                                
                                if (node.customOutputs.timestamp) {
                                    const newLastTime = parseInt(node.customOutputs.timestamp);
                                    if (newLastTime > 0) {
                                        const oldValue = lastMessageTime;
                                        lastMessageTime = newLastTime;
                                        addLog(`ğŸ• âœ… ä»${node.moduleName || 'èŠ‚ç‚¹'}çš„customOutputs.timestampæ›´æ–°å…¨å±€å˜é‡: ${oldValue} â†’ ${lastMessageTime}`, 'success');
                                        return;
                                    }
                                }
                            }
                        }
                    }
                    
                    // æ–¹æ³•3ï¼šå¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œå¹¶ä¸”lastMessageTimeè¿˜æ˜¯0ï¼Œåˆ™ä½¿ç”¨å½“å‰æ—¶é—´
                    if (lastMessageTime === 0) {
                        const oldValue = lastMessageTime;
                        lastMessageTime = Date.now();
                        addLog(`ğŸ• æœªæ‰¾åˆ°APIè¿”å›çš„æ—¶é—´æˆ³ï¼Œä½¿ç”¨å½“å‰æ—¶é—´åˆå§‹åŒ–: ${oldValue} â†’ ${lastMessageTime}`, 'warning');
                        } else {
                        addLog(`ğŸ• æœªæ‰¾åˆ°æ–°çš„æ—¶é—´æˆ³ï¼Œä¿æŒç°æœ‰å€¼: ${lastMessageTime}`, 'info');
                    }
                    
                } catch (error) {
                    addLog(`âŒ æå–lastTimeå¤±è´¥: ${error.message}`, 'error');
                }
                
                // ğŸ” è®°å½•å‡½æ•°ç»“æŸæ—¶çš„å€¼
                addLog(`ğŸ” [ç›‘æ§] extractAndUpdateLastTimeç»“æŸï¼Œæœ€ç»ˆlastTime: ${lastMessageTime}`, 'info');
            }
            
            // ğŸ”§ æ–°å¢ï¼šæå–å¹¶æ›´æ–°read_timeçš„ä¸“ç”¨å‡½æ•°
            function extractAndUpdateReadTime(responseData) {
                try {
                    let newReadTime = null;
                    
                    // ğŸ”§ ä¼˜å…ˆæ–¹æ³•ï¼šä»pluginOutput.readtimeä¸­æå–ï¼ˆæ ¹æ®æŠ¥æ–‡ç»“æ„ï¼‰
                    if (Array.isArray(responseData.responseData)) {
                        for (const node of responseData.responseData) {
                            // æŸ¥æ‰¾åŒ…å«pluginOutput.readtimeçš„èŠ‚ç‚¹
                            if (node && node.pluginOutput && node.pluginOutput.readtime) {
                                newReadTime = parseInt(node.pluginOutput.readtime);
                                if (newReadTime > 0) {
                                    const oldValue = currentReadTime;
                                    currentReadTime = newReadTime;
                                    addLog(`ğŸ“– ä»${node.moduleName || 'æ’ä»¶èŠ‚ç‚¹'}çš„pluginOutput.readtimeæ›´æ–°é˜…è¯»æ—¶é—´: ${oldValue || 'æœªè®¾ç½®'}ms â†’ ${currentReadTime}ms (${Math.ceil(currentReadTime/1000)}ç§’)`, 'success');
                                    
                                    // ğŸ”§ æ–°å¢ï¼šé¦–æ¬¡è·å–read_timeæ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
                                    if (oldValue === null) {
                                        addLog(`âš™ï¸ ä»APIè·å–åˆ°çœŸå®é…ç½® - é˜…è¯»æ—¶é—´: ${currentReadTime}msï¼Œå®šæ—¶ä»»åŠ¡å»¶è¿Ÿ: ${currentReadTime + 1000}ms (${Math.ceil((currentReadTime + 1000)/1000)}ç§’)`, 'success');
                                    }
                                    
                                    return currentReadTime;
                                }
                            }
                        }
                    }
                    
                    // æ–¹æ³•2ï¼šä»customOutputsä¸­æå–read_time
                    if (Array.isArray(responseData.responseData)) {
                        for (const node of responseData.responseData) {
                            // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆæ£€æŸ¥customOutputs
                            if (node && node.customOutputs && node.customOutputs.read_time) {
                                newReadTime = parseInt(node.customOutputs.read_time);
                                if (newReadTime > 0) {
                                    const oldValue = currentReadTime;
                                    currentReadTime = newReadTime;
                                    addLog(`ğŸ“– ä»${node.moduleName || 'ä»£ç èŠ‚ç‚¹'}çš„customOutputsæ›´æ–°é˜…è¯»æ—¶é—´: ${oldValue || 'æœªè®¾ç½®'}ms â†’ ${currentReadTime}ms (${Math.ceil(currentReadTime/1000)}ç§’)`, 'success');
                                    
                                    // ğŸ”§ æ–°å¢ï¼šé¦–æ¬¡è·å–read_timeæ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
                                    if (oldValue === null) {
                                        addLog(`âš™ï¸ ä»APIè·å–åˆ°çœŸå®é…ç½® - é˜…è¯»æ—¶é—´: ${currentReadTime}msï¼Œå®šæ—¶ä»»åŠ¡å»¶è¿Ÿ: ${currentReadTime + 1000}ms (${Math.ceil((currentReadTime + 1000)/1000)}ç§’)`, 'success');
                                    }
                                    
                                    return currentReadTime;
                                }
                            }
                            
                            // æ‰©å±•ï¼šåœ¨customOutputsä¸­æŸ¥æ‰¾å¯èƒ½çš„æ—¶é—´ç›¸å…³å­—æ®µ
                            if (node && node.customOutputs) {
                                for (const [key, value] of Object.entries(node.customOutputs)) {
                                    if ((key.includes('read') || key.includes('time')) && typeof value === 'number' && value > 500 && value < 60000) {
                                        const oldValue = currentReadTime;
                                        currentReadTime = value;
                                        addLog(`ğŸ“– ä»${node.moduleName || 'èŠ‚ç‚¹'}çš„customOutputs.${key}æ›´æ–°é˜…è¯»æ—¶é—´: ${oldValue || 'æœªè®¾ç½®'}ms â†’ ${currentReadTime}ms (${Math.ceil(currentReadTime/1000)}ç§’)`, 'success');
                                        
                                        // ğŸ”§ æ–°å¢ï¼šé¦–æ¬¡è·å–read_timeæ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
                                        if (oldValue === null) {
                                            addLog(`âš™ï¸ ä»APIè·å–åˆ°çœŸå®é…ç½® - é˜…è¯»æ—¶é—´: ${currentReadTime}msï¼Œå®šæ—¶ä»»åŠ¡å»¶è¿Ÿ: ${currentReadTime + 1000}ms (${Math.ceil((currentReadTime + 1000)/1000)}ç§’)`, 'success');
                                        }
                                        
                                        return currentReadTime;
                                    }
                                }
                            }
                        }
                    }
                    
                    // æ–¹æ³•3ï¼šä»newVariablesä¸­æå–ï¼ˆé™ä½ä¼˜å…ˆçº§ï¼‰
                    if (responseData.newVariables && responseData.newVariables.read_time) {
                        newReadTime = parseInt(responseData.newVariables.read_time);
                        if (newReadTime > 0) {
                            const oldValue = currentReadTime;
                            currentReadTime = newReadTime;
                            addLog(`ğŸ“– ä»newVariablesæ›´æ–°é˜…è¯»æ—¶é—´: ${oldValue || 'æœªè®¾ç½®'}ms â†’ ${currentReadTime}ms (${Math.ceil(currentReadTime/1000)}ç§’)`, 'success');
                            
                            // ğŸ”§ æ–°å¢ï¼šé¦–æ¬¡è·å–read_timeæ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
                            if (oldValue === null) {
                                addLog(`âš™ï¸ ä»APIè·å–åˆ°çœŸå®é…ç½® - é˜…è¯»æ—¶é—´: ${currentReadTime}msï¼Œå®šæ—¶ä»»åŠ¡å»¶è¿Ÿ: ${currentReadTime + 1000}ms (${Math.ceil((currentReadTime + 1000)/1000)}ç§’)`, 'success');
                            }
                            
                            return currentReadTime;
                        }
                    }
                    
                    // æ–¹æ³•4ï¼šå¤‡ç”¨æ£€æŸ¥outputs
                    if (Array.isArray(responseData.responseData)) {
                        for (const node of responseData.responseData) {
                            if (node && node.outputs && node.outputs.read_time) {
                                newReadTime = parseInt(node.outputs.read_time);
                                if (newReadTime > 0) {
                                    const oldValue = currentReadTime;
                                    currentReadTime = newReadTime;
                                    addLog(`ğŸ“– ä»${node.moduleName || 'èŠ‚ç‚¹'}çš„outputsæ›´æ–°é˜…è¯»æ—¶é—´: ${oldValue || 'æœªè®¾ç½®'}ms â†’ ${currentReadTime}ms (${Math.ceil(currentReadTime/1000)}ç§’)`, 'success');
                                    
                                    // ğŸ”§ æ–°å¢ï¼šé¦–æ¬¡è·å–read_timeæ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
                                    if (oldValue === null) {
                                        addLog(`âš™ï¸ ä»APIè·å–åˆ°çœŸå®é…ç½® - é˜…è¯»æ—¶é—´: ${currentReadTime}msï¼Œå®šæ—¶ä»»åŠ¡å»¶è¿Ÿ: ${currentReadTime + 1000}ms (${Math.ceil((currentReadTime + 1000)/1000)}ç§’)`, 'success');
                                    }
                                    
                                    return currentReadTime;
                                }
                            }
                            
                            // å¤‡ç”¨ï¼šåœ¨outputsä¸­æŸ¥æ‰¾å¯èƒ½çš„æ—¶é—´ç›¸å…³å­—æ®µ
                            if (node && node.outputs) {
                                for (const [key, value] of Object.entries(node.outputs)) {
                                    if ((key.includes('read') || key.includes('time')) && typeof value === 'number' && value > 500 && value < 60000) {
                                        const oldValue = currentReadTime;
                                        currentReadTime = value;
                                        addLog(`ğŸ“– ä»${node.moduleName || 'èŠ‚ç‚¹'}çš„outputs.${key}æ›´æ–°é˜…è¯»æ—¶é—´: ${oldValue || 'æœªè®¾ç½®'}ms â†’ ${currentReadTime}ms (${Math.ceil(currentReadTime/1000)}ç§’)`, 'success');
                                        
                                        // ğŸ”§ æ–°å¢ï¼šé¦–æ¬¡è·å–read_timeæ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
                                        if (oldValue === null) {
                                            addLog(`âš™ï¸ ä»APIè·å–åˆ°çœŸå®é…ç½® - é˜…è¯»æ—¶é—´: ${currentReadTime}msï¼Œå®šæ—¶ä»»åŠ¡å»¶è¿Ÿ: ${currentReadTime + 1000}ms (${Math.ceil((currentReadTime + 1000)/1000)}ç§’)`, 'success');
                                        }
                                        
                                        return currentReadTime;
                                    }
                                }
                            }
                        }
                    }
                    
                    // ğŸ”§ ä¿®æ”¹ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°read_timeï¼Œè®°å½•é”™è¯¯ä½†ä¸è®¾ç½®é»˜è®¤å€¼
                    if (currentReadTime === null) {
                        addLog(`âŒ ä¸¥é‡é”™è¯¯ï¼šæœªèƒ½ä»APIå“åº”ä¸­è·å–read_timeå˜é‡ï¼Œè¯·æ£€æŸ¥å·¥ä½œæµé…ç½®`, 'error');
                        addLog(`âš ï¸ æç¤ºï¼šå·¥ä½œæµå¿…é¡»åŒ…å«è¾“å‡ºread_timeå˜é‡çš„ä»£ç èŠ‚ç‚¹`, 'warning');
                        addLog(`ğŸ” è°ƒè¯•ï¼šè¯·æ£€æŸ¥pluginOutput.readtimeã€customOutputs.read_timeæˆ–outputs.read_timeå­—æ®µ`, 'info');
                        return null;
                    } else {
                        addLog(`ğŸ“– ä¿æŒç°æœ‰é˜…è¯»æ—¶é—´: ${currentReadTime}ms`, 'info');
                    }
                    
                    return currentReadTime;
                    
                } catch (error) {
                    addLog(`âŒ æå–read_timeå¤±è´¥: ${error.message}`, 'error');
                    return currentReadTime;
                }
            }
            
            // å¤„ç†APIå“åº”
            function handleResponse(responseData, requestType = 'ç¬¬ä¸€æ¬¡') {
                // ğŸ” ç›‘æ§å“åº”å¤„ç†å¼€å§‹æ—¶çš„lastTimeå€¼
                addLog(`ğŸ” [ç›‘æ§] handleResponseå¼€å§‹ï¼Œå½“å‰lastTime: ${lastMessageTime}`, 'info');
                
                // ğŸ”§ é¦–å…ˆä»APIå“åº”ä¸­æå–å¹¶æ›´æ–°read_time
                extractAndUpdateReadTime(responseData);
                
                // ğŸ”§ ä»APIå“åº”ä¸­æå–å¹¶æ›´æ–°lastTime (å…¨å±€å˜é‡)
                extractAndUpdateLastTime(responseData);
                
                // ğŸ”§ æ£€æŸ¥isTimeUpå‚æ•°ï¼Œå†³å®šæ˜¯å¦é˜»æ–­ç¬¬äºŒæ¬¡è¯·æ±‚
                checkAndHandleTimeUpStatus(responseData, requestType);
                
                // ğŸ” ç›‘æ§ä¸¤ä¸ªæå–å‡½æ•°æ‰§è¡Œåçš„lastTimeå€¼
                addLog(`ğŸ” [ç›‘æ§] æå–å‡½æ•°æ‰§è¡Œåï¼ŒlastTime: ${lastMessageTime}`, 'info');
                
                let aiResponse = '';
                let hasValidResponse = false;

                // ğŸ”§ æœ€é«˜ä¼˜å…ˆçº§ï¼šæŸ¥æ‰¾textOutputå˜é‡ï¼ˆæŒ‡å®šå›å¤èŠ‚ç‚¹çš„å†…å®¹ï¼‰
                if (Array.isArray(responseData.responseData)) {
                    for (const node of responseData.responseData) {
                        // æŸ¥æ‰¾åŒ…å«textOutputçš„èŠ‚ç‚¹ï¼ˆå¦‚æŒ‡å®šå›å¤èŠ‚ç‚¹ã€ç»“æŸèŠ‚ç‚¹ç­‰ï¼‰
                        if (node && node.textOutput) {
                            aiResponse = String(node.textOutput);
                            addLog(`ğŸ“ ä»${node.moduleName || 'èŠ‚ç‚¹'}çš„textOutputè·å–å›å¤å†…å®¹`, 'success');
                            addLog(`âœ… textOutputå†…å®¹: ${aiResponse.substring(0, 50)}...`, 'success');
                            addLog(`ğŸ“Š å†…å®¹é•¿åº¦: ${aiResponse.length}å­—ç¬¦`, 'info');
                            hasValidResponse = true;
                            break; // æ‰¾åˆ°textOutputå°±åœæ­¢æŸ¥æ‰¾
                        }
                        
                        // å¤‡ç”¨ï¼šæŸ¥æ‰¾loopOutputValueï¼ˆç»“æŸèŠ‚ç‚¹çš„è¾“å‡ºï¼‰
                        if (!hasValidResponse && node && node.loopOutputValue) {
                            aiResponse = String(node.loopOutputValue);
                            addLog(`ğŸ“ ä»${node.moduleName || 'èŠ‚ç‚¹'}çš„loopOutputValueè·å–å›å¤å†…å®¹`, 'success');
                            addLog(`âœ… loopOutputValueå†…å®¹: ${aiResponse.substring(0, 50)}...`, 'success');
                            addLog(`ğŸ“Š å†…å®¹é•¿åº¦: ${aiResponse.length}å­—ç¬¦`, 'info');
                            hasValidResponse = true;
                            break;
                        }
                    }
                }

                // ğŸ”§ æ¬¡çº§ä¼˜å…ˆçº§ï¼šæŸ¥æ‰¾contentå˜é‡ï¼ˆæ”¯æŒå¢å¼ºå›å¤3.0ï¼‰
                if (!hasValidResponse && Array.isArray(responseData.responseData)) {
                    for (const node of responseData.responseData) {
                        // 1. ä¼˜å…ˆæŸ¥æ‰¾å¢å¼ºå›å¤3.0åŠç›¸å…³ç‰ˆæœ¬çš„contentå˜é‡
                        if (node && (node.moduleName === 'å¢å¼ºå›å¤3.0ç‰ˆæœ¬' || 
                                   node.moduleName === 'å¢å¼ºå›å¤2.0ç‰ˆæœ¬ Copy#2' || 
                                   node.moduleName.includes('å¢å¼ºå›å¤'))) {
                            addLog(`ğŸ­ å‘ç°å¢å¼ºå›å¤èŠ‚ç‚¹: ${node.moduleName}`, 'success');
                            
                            // æŸ¥æ‰¾contentå˜é‡
                            let content = null;
                            
                            // æ–¹æ³•1ï¼šä»customOutputsä¸­è·å–content
                            if (node.customOutputs && node.customOutputs.content) {
                                content = node.customOutputs.content;
                                addLog(`ğŸ“ ä»${node.moduleName}çš„customOutputs.contentè·å–å†…å®¹`, 'success');
                            }
                            // æ–¹æ³•2ï¼šä»outputsä¸­è·å–content
                            else if (node.outputs && node.outputs.content) {
                                content = node.outputs.content;
                                addLog(`ğŸ“ ä»${node.moduleName}çš„outputs.contentè·å–å†…å®¹`, 'success');
                            }
                            // æ–¹æ³•3ï¼šä»pluginOutputä¸­è·å–content
                            else if (node.pluginOutput && node.pluginOutput.content) {
                                content = node.pluginOutput.content;
                                addLog(`ğŸ“ ä»${node.moduleName}çš„pluginOutput.contentè·å–å†…å®¹`, 'success');
                            }
                            // æ–¹æ³•4ï¼šä»newVariablesä¸­è·å–content
                            else if (responseData.newVariables && responseData.newVariables.content) {
                                content = responseData.newVariables.content;
                                addLog(`ğŸ“ ä»newVariables.contentè·å–å†…å®¹`, 'success');
                            }
                            
                            if (content) {
                                aiResponse = String(content);
                                addLog(`âœ… æˆåŠŸè·å–contentå†…å®¹: ${aiResponse.substring(0, 50)}...`, 'success');
                                addLog(`ğŸ“Š å†…å®¹é•¿åº¦: ${aiResponse.length}å­—ç¬¦`, 'info');
                                hasValidResponse = true;
                                break; // æ‰¾åˆ°contentå°±åœæ­¢æŸ¥æ‰¾
                            }
                        }
                    }
                }
                
                // 2. å¦‚æœæ²¡æœ‰æ‰¾åˆ°contentå˜é‡ï¼ŒæŸ¥æ‰¾ä¼ ç»Ÿçš„å¯¹è¯èŠ‚ç‚¹å›å¤
                if (!hasValidResponse && Array.isArray(responseData.responseData)) {
                    addLog(`ğŸ” æœªæ‰¾åˆ°contentå˜é‡ï¼ŒæŸ¥æ‰¾ä¼ ç»Ÿå¯¹è¯èŠ‚ç‚¹å›å¤`, 'info');
                    
                        const chatNodes = responseData.responseData.filter(
                            item => typeof item === 'object' && 
                            item.moduleType === 'chatNode' && 
                            item.historyPreview
                        );
                        
                        if (chatNodes.length > 0) {
                            const lastChatNode = chatNodes[chatNodes.length - 1];
                            const historyPreview = lastChatNode.historyPreview || [];
                            const aiMessages = historyPreview.filter(msg => msg.obj === 'AI');
                            
                            if (aiMessages.length > 0) {
                                aiResponse = aiMessages[aiMessages.length - 1].value;
                                addLog(`ğŸ’¬ ä»å¯¹è¯èŠ‚ç‚¹æå–AIå›å¤: ${aiResponse.substring(0, 50)}...`, 'success');
                            hasValidResponse = true;
                        }
                    }
                }
                
                // 3. å¤‡ç”¨ï¼šæ ‡å‡†OpenAIæ ¼å¼å“åº”
                if (!hasValidResponse && responseData.choices && responseData.choices.length > 0) {
                        if (responseData.choices[0].message) {
                            aiResponse = responseData.choices[0].message.content;
                            addLog(`ğŸ¤– ä»OpenAIæ ¼å¼æå–å›å¤: ${aiResponse.substring(0, 50)}...`, 'success');
                        hasValidResponse = true;
                    }
                }
                
                // 4. æ˜¾ç¤ºå›å¤å†…å®¹
                if (hasValidResponse && aiResponse) {
                    addLog(`ğŸ’¬ ${requestType}ç›´æ¥æ˜¾ç¤ºAPIåŸæ–‡å†…å®¹ï¼ˆä¸åˆ†æ®µï¼‰`, 'info');
                    processDirectResponse(aiResponse);
                } else {
                    addLog(`âš ï¸ ${requestType}è¯·æ±‚æ— æœ‰æ•ˆå›å¤å†…å®¹ï¼Œè·³è¿‡æ˜¾ç¤º`, 'warning');
                    addLog(`ğŸ” å®Œæ•´å“åº”ç»“æ„è¯·æŸ¥çœ‹è°ƒè¯•é¢æ¿`, 'info');
                }
            }
            
            // ğŸ”§ æ–°å¢ï¼šç›´æ¥æ˜¾ç¤ºå›å¤å†…å®¹ï¼ˆä¸åˆ†æ®µï¼‰
            function processDirectResponse(text) {
                // å¤„ç†emojiå’Œç‰¹æ®Šå­—ç¬¦
                const processedText = processEmojiAndText(text);
                
                // åˆ›å»ºAIæ¶ˆæ¯æ¡†
                const messageElement = document.createElement('div');
                messageElement.className = 'message message-ai';
                messageElement.innerHTML = `
                    <div class="avatar">AI</div>
                    <div class="message-content"></div>
                `;
                chatMessages.appendChild(messageElement);
                
                const messageContent = messageElement.querySelector('.message-content');
                
                // ç›´æ¥æ˜¾ç¤ºå®Œæ•´å†…å®¹ï¼Œä¿æŒAPIåŸæ–‡æ ¼å¼
                messageContent.innerHTML = processedText;
                
                // ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                addLog(`âœ… å†…å®¹æ˜¾ç¤ºå®Œæˆï¼Œä¿æŒåŸæ–‡æ ¼å¼`, 'success');
            }
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
            function addMessage(sender, text) {
                // ğŸ”§ æ–°å¢ï¼šå¤„ç†emojiå’Œç‰¹æ®Šå­—ç¬¦
                const processedText = processEmojiAndText(text);
                
                const messageElement = document.createElement('div');
                messageElement.className = `message message-${sender === 'ç”¨æˆ·' ? 'user' : 'ai'}`;
                
                // ä½¿ç”¨innerHTMLæ˜¾ç¤ºæ–‡æœ¬ï¼Œç¡®ä¿emojiæ­£å¸¸æ˜¾ç¤º
                messageElement.innerHTML = `
                    <div class="avatar">${sender === 'ç”¨æˆ·' ? 'æˆ‘' : 'AI'}</div>
                    <div class="message-content">${processedText}</div>
                `;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // æ·»åŠ æ—¥å¿—
            function addLog(message, type = 'info') {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.innerHTML = `<span class="log-time">[${timeString}]</span> ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œæ–¹ä¾¿è°ƒè¯•
                if (type === 'error') {
                    console.error(message);
                } else if (type === 'warning') {
                    console.warn(message);
                } else if (type === 'success') {
                    console.log(`%c${message}`, 'color: green');
                } else {
                    console.log(message);
                }
            }
            
            // å·¥å…·å‡½æ•° - Sleep
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // ğŸ”§ æ£€æŸ¥å¹¶å¤„ç†isTimeUpçŠ¶æ€
            function checkAndHandleTimeUpStatus(responseData, requestType) {
                try {
                    addLog(`ğŸ” [æ£€æŸ¥isTimeUp] è¯·æ±‚ç±»å‹: ${requestType}`, 'info');
                    
                    // ç¬¬äºŒæ¬¡è¯·æ±‚ç›´æ¥è¿”å›
                    if (requestType === 'ç¬¬äºŒæ¬¡') {
                        addLog(`âœ… ç¬¬äºŒæ¬¡è¯·æ±‚å®Œæˆ`, 'success');
                        hasReceivedResponse = true;
                        return;
                    }
                    
                    // åªæœ‰ç¬¬ä¸€æ¬¡è¯·æ±‚æ‰éœ€è¦æ£€æŸ¥isTimeUp
                    if (requestType !== 'ç¬¬ä¸€æ¬¡') {
                        return;
                    }
                    
                    let isTimeUp = null; // æ”¹ä¸ºnullï¼Œä¾¿äºåŒºåˆ†æ˜¯å¦æ‰¾åˆ°äº†å€¼
                    let foundSource = ''; // è®°å½•æ‰¾åˆ°å€¼çš„æ¥æº
                    
                    // ğŸ” è¯¦ç»†éå†æ‰€æœ‰èŠ‚ç‚¹ï¼ŒæŸ¥æ‰¾isTimeUp
                    addLog(`ğŸ” å¼€å§‹éå†${responseData.responseData?.length || 0}ä¸ªå“åº”èŠ‚ç‚¹`, 'info');
                    
                    if (Array.isArray(responseData.responseData)) {
                        for (let i = 0; i < responseData.responseData.length; i++) {
                            const node = responseData.responseData[i];
                            addLog(`ğŸ” [èŠ‚ç‚¹${i}] åç§°: ${node.moduleName || 'æœªçŸ¥'}, ç±»å‹: ${node.moduleType || 'æœªçŸ¥'}`, 'info');
                            
                            // ä¼˜å…ˆæŸ¥æ‰¾ä»£ç èŠ‚ç‚¹çš„isTimeUpè¾“å‡ºï¼ˆçœŸå®è®¡ç®—å€¼ï¼‰
                            if (node && node.customOutputs && node.customOutputs.isTimeUp !== undefined) {
                                isTimeUp = node.customOutputs.isTimeUp;
                                foundSource = `${node.moduleName || 'ä»£ç èŠ‚ç‚¹'}çš„customOutputs`;
                                addLog(`ğŸ” âœ… ä»${foundSource}è·å–isTimeUp: ${isTimeUp}`, 'success');
                                break;
                            }
                            
                            if (node && node.outputs && node.outputs.isTimeUp !== undefined) {
                                isTimeUp = node.outputs.isTimeUp;
                                foundSource = `${node.moduleName || 'èŠ‚ç‚¹'}çš„outputs`;
                                addLog(`ğŸ” âœ… ä»${foundSource}è·å–isTimeUp: ${isTimeUp}`, 'success');
                                break;
                            }
                            
                            // ğŸ” è®°å½•æ‰€æœ‰å¯èƒ½åŒ…å«isTimeUpçš„å­—æ®µ
                            if (node && node.customOutputs) {
                                const customKeys = Object.keys(node.customOutputs);
                                if (customKeys.length > 0) {
                                    addLog(`ğŸ” [èŠ‚ç‚¹${i}] customOutputså­—æ®µ: ${customKeys.join(', ')}`, 'info');
                                }
                            }
                            
                            if (node && node.outputs) {
                                const outputKeys = Object.keys(node.outputs);
                                if (outputKeys.length > 0) {
                                    addLog(`ğŸ” [èŠ‚ç‚¹${i}] outputså­—æ®µ: ${outputKeys.join(', ')}`, 'info');
                                }
                            }
                        }
                    }
                    
                    // å¤‡ç”¨ï¼šä»newVariablesä¸­è·å–ï¼ˆå¯èƒ½æ˜¯ç¼“å­˜å€¼ï¼Œä¼˜å…ˆçº§è¾ƒä½ï¼‰
                    if (isTimeUp === null && responseData.newVariables && responseData.newVariables.isTimeUp !== undefined) {
                        isTimeUp = responseData.newVariables.isTimeUp;
                        foundSource = 'newVariables';
                        addLog(`ğŸ” âš ï¸ ä»${foundSource}è·å–isTimeUp: ${isTimeUp} (å¤‡ç”¨æ–¹æ¡ˆ)`, 'warning');
                    }
                    
                    // ğŸš¨ ç‰¹æ®Šé€»è¾‘ï¼šå¦‚æœå·²ç»æœ‰AIå›å¤å†…å®¹ï¼Œä½†isTimeUpæ˜¯falseï¼Œè¿™å¯èƒ½æ˜¯é”™è¯¯çš„
                    if (isTimeUp === false) {
                        addLog(`ğŸš¨ æ£€æµ‹åˆ°isTimeUp=falseä½†ç¬¬ä¸€æ¬¡è¯·æ±‚æœ‰å›å¤å†…å®¹ï¼Œè¿™å¯èƒ½ä¸æ­£ç¡®`, 'warning');
                        addLog(`ğŸ” æ•°æ®æ¥æº: ${foundSource}`, 'info');
                        
                        // æ£€æŸ¥æ˜¯å¦çœŸçš„æœ‰å›å¤å†…å®¹
                        let hasReplyContent = false;
                        if (Array.isArray(responseData.responseData)) {
                            for (const node of responseData.responseData) {
                                if (node && (node.textOutput || node.loopOutputValue)) {
                                    hasReplyContent = true;
                                    addLog(`âœ… ç¡®è®¤æœ‰å›å¤å†…å®¹æ¥è‡ª: ${node.moduleName}`, 'success');
                                    break;
                                }
                            }
                        }
                        
                        if (hasReplyContent) {
                            addLog(`ğŸš¨ é€»è¾‘ä¿®æ­£ï¼šæ—¢ç„¶æœ‰å›å¤å†…å®¹ï¼Œå°†isTimeUpä¿®æ­£ä¸ºtrue`, 'warning');
                            isTimeUp = true;
                            foundSource += ' (å·²ä¿®æ­£)';
                        }
                    }
                    
                    addLog(`ğŸ¯ ç¬¬ä¸€æ¬¡è¯·æ±‚isTimeUpæœ€ç»ˆå€¼: ${isTimeUp} (æ¥æº: ${foundSource})`, 'success');
                    
                    // ğŸš¨ æ ¸å¿ƒé€»è¾‘
                    if (isTimeUp === true) {
                        // æ—¶é—´å·²åˆ°ï¼Œåªæœ‰ä¸€æ¬¡å›å¤ï¼Œä¸å¯åŠ¨ç¬¬äºŒæ¬¡è¯·æ±‚
                        addLog(`â° âœ… isTimeUp=trueï¼Œæ—¶é—´å·²åˆ°ï¼Œåªæœ‰ä¸€æ¬¡å›å¤`, 'success');
                        hasReceivedResponse = true;
                        
                        // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å®šæ—¶å™¨
                        if (timeoutTimer) {
                            clearTimeout(timeoutTimer);
                            timeoutTimer = null;
                            addLog(`ğŸ—‘ï¸ æ¸…é™¤å®šæ—¶å™¨`, 'info');
                        }
                        
                    } else if (isTimeUp === false) {
                        // æ—¶é—´æœªåˆ°ï¼Œå¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œç­‰å¾…ç¬¬äºŒæ¬¡è¯·æ±‚
                        addLog(`â° â³ isTimeUp=falseï¼Œæ—¶é—´æœªåˆ°ï¼Œå¯åŠ¨å®šæ—¶ä»»åŠ¡`, 'info');
                        
                        if (currentReadTime !== null && currentReadTime > 0) {
                            startDelayedSecondRequest();
                        } else {
                            addLog(`âŒ æœªè·å–åˆ°read_timeï¼Œæ— æ³•å¯åŠ¨å®šæ—¶ä»»åŠ¡`, 'warning');
                            hasReceivedResponse = true;
                        }
                        
                    } else {
                        // isTimeUpæœªå®šä¹‰ï¼Œå®‰å…¨èµ·è§åªæœ‰ä¸€æ¬¡å›å¤
                        addLog(`âš ï¸ æ— æ³•è·å–isTimeUpçŠ¶æ€ (å€¼ä¸º${isTimeUp})ï¼Œå®‰å…¨èµ·è§åªæœ‰ä¸€æ¬¡å›å¤`, 'warning');
                        hasReceivedResponse = true;
                    }
                    
                } catch (error) {
                    addLog(`âŒ æ£€æŸ¥isTimeUpå¤±è´¥: ${error.message}`, 'error');
                    hasReceivedResponse = true;
                }
            }
            
            // ğŸ”§ æ–°å¢ï¼šå¤„ç†emojiå’Œç‰¹æ®Šå­—ç¬¦çš„å‡½æ•°
            function processEmojiAndText(text) {
                if (!text || typeof text !== 'string') {
                    return text;
                }
                
                const originalText = text;
                let processedCount = 0;
                
                // ğŸ”§ å¤„ç†å¼•ç”¨æ ¼å¼çš„emojiï¼Œå¦‚ [682b4ff2e334c475dc1abda5](CITE)
                text = text.replace(/\[([a-f0-9]+)\]\(CITE\)/g, (match, emojiCode) => {
                    processedCount++;
                    addLog(`ğŸ­ æ£€æµ‹åˆ°emojiç¼–ç : [${emojiCode}](CITE)`, 'info');
                    
                    // å°†16è¿›åˆ¶ç¼–ç è½¬æ¢ä¸ºemojiï¼ˆå¦‚æœæ˜¯æœ‰æ•ˆçš„unicodeï¼‰
                    try {
                        // å¦‚æœæ˜¯32ä½hexï¼Œå°è¯•è½¬æ¢ä¸ºemoji
                        if (emojiCode.length >= 8) {
                            const codePoint = parseInt(emojiCode.substring(0, 8), 16);
                            if (codePoint > 0x1F000 && codePoint < 0x1FFFF) {
                                const emoji = String.fromCodePoint(codePoint);
                                addLog(`ğŸ­ è½¬æ¢ä¸ºunicode emoji: ${emoji}`, 'success');
                                return emoji;
                            }
                        }
                        // ç‰¹æ®Šå¤„ç†ï¼šæ ¹æ®hex codeçš„ç‰¹å¾è¿”å›ç›¸åº”emoji
                        const firstChars = emojiCode.substring(0, 4).toLowerCase();
                        const emojiMapping = {
                            '682b': 'ğŸ˜Š', // ç¬‘è„¸
                            '1f60': 'ğŸ˜Š', // å„ç§ç¬‘è„¸
                            '1f44': 'ğŸ‘', // èµ
                            '1f49': 'ğŸ’°', // é’±è¢‹
                            '1f91': 'ğŸ¤', // æ¡æ‰‹
                            '1f68': 'ğŸš€', // ç«ç®­
                            '2728': 'âœ¨', // æ˜Ÿæ˜Ÿ
                            '1f52': 'ğŸ”¥'  // ç«
                        };
                        
                        for (const [key, emoji] of Object.entries(emojiMapping)) {
                            if (emojiCode.startsWith(key)) {
                                addLog(`ğŸ­ æ˜ å°„åˆ°é¢„è®¾emoji: ${emoji} (åŒ¹é…${key})`, 'success');
                                return emoji;
                            }
                        }
                        
                        // å¦‚æœä¸åŒ¹é…ï¼Œè¿”å›é»˜è®¤è¡¨æƒ…
                        addLog(`ğŸ­ ä½¿ç”¨é»˜è®¤emoji: ğŸ˜Š`, 'info');
                        return 'ğŸ˜Š';
                    } catch (error) {
                        addLog(`ğŸ­ emojiè½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤: ğŸ˜Š`, 'warning');
                        return 'ğŸ˜Š'; // é»˜è®¤è¡¨æƒ…
                    }
                });
                
                // ğŸ”§ å¤„ç†å…¶ä»–å¯èƒ½çš„emojiæ ¼å¼
                // å¤„ç† :emoji_name: æ ¼å¼
                const emojiMap = {
                    ':smile:': 'ğŸ˜Š',
                    ':grin:': 'ğŸ˜',
                    ':laughing:': 'ğŸ˜„',
                    ':thumbs_up:': 'ğŸ‘',
                    ':thumbsup:': 'ğŸ‘',
                    ':heart:': 'â¤ï¸',
                    ':fire:': 'ğŸ”¥',
                    ':star:': 'â­',
                    ':rocket:': 'ğŸš€',
                    ':money:': 'ğŸ’°',
                    ':moneybag:': 'ğŸ’°',
                    ':handshake:': 'ğŸ¤',
                    ':success:': 'âœ…',
                    ':check:': 'âœ…',
                    ':warning:': 'âš ï¸',
                    ':sparkles:': 'âœ¨',
                    ':clap:': 'ğŸ‘',
                    ':wave:': 'ğŸ‘‹',
                    ':100:': 'ğŸ’¯'
                };
                
                Object.keys(emojiMap).forEach(key => {
                    if (text.includes(key)) {
                        text = text.replace(new RegExp(key, 'g'), emojiMap[key]);
                        processedCount++;
                        addLog(`ğŸ­ è½¬æ¢emojiä»£ç : ${key} â†’ ${emojiMap[key]}`, 'success');
                    }
                });
                
                // ğŸ”§ å¤„ç†unicodeè½¬ä¹‰åºåˆ—ï¼Œå¦‚ \uXXXX
                text = text.replace(/\\u([0-9a-fA-F]{4})/g, (match, code) => {
                    try {
                        processedCount++;
                        const emoji = String.fromCharCode(parseInt(code, 16));
                        addLog(`ğŸ­ è½¬æ¢unicodeè½¬ä¹‰: ${match} â†’ ${emoji}`, 'success');
                        return emoji;
                    } catch (error) {
                        return match;
                    }
                });
                
                // ğŸ” è®°å½•å¤„ç†ç»“æœ
                if (processedCount > 0) {
                    addLog(`ğŸ­ emojiå¤„ç†å®Œæˆï¼Œå…±å¤„ç†${processedCount}ä¸ªè¡¨æƒ…ç¬¦å·`, 'success');
                    addLog(`ğŸ­ å¤„ç†å‰: ${originalText.substring(0, 50)}...`, 'info');
                    addLog(`ğŸ­ å¤„ç†å: ${text.substring(0, 50)}...`, 'success');
                }
                
                return text;
            }
            
            // å¯åŠ¨å»¶è¿Ÿçš„ç¬¬äºŒæ¬¡è¯·æ±‚
            function startDelayedSecondRequest() {
                // æ£€æŸ¥æ˜¯å¦å·²è·å–åˆ°çœŸå®çš„read_time
                if (currentReadTime === null) {
                    addLog(`âŒ æ— æ³•å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼šå°šæœªä»APIè·å–åˆ°read_timeå˜é‡`, 'error');
                    return;
                }
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (timeoutTimer) {
                    clearTimeout(timeoutTimer);
                    timeoutTimer = null;
                }
                
                isReading = true;
                readingStartTime = Date.now();
                
                // å®šæ—¶ä»»åŠ¡å»¶è¿Ÿæ—¶é—´ = read_time + 1ç§’
                const delayTime = currentReadTime + 1000;
                
                addLog(`ğŸ“– å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œ${delayTime}ms (${currentReadTime}ms + 1ç§’) åå°†å‘é€ç¬¬äºŒæ¬¡è¯·æ±‚`, 'info');
                
                timeoutTimer = setTimeout(() => {
                    addLog(`â° [å®šæ—¶å™¨è§¦å‘] å¼€å§‹å‘é€ç¬¬äºŒæ¬¡è¯·æ±‚`, 'success');
                    
                    // æ£€æŸ¥çŠ¶æ€
                    if (hasReceivedResponse) {
                        addLog(`ğŸ›‘ ç¬¬ä¸€æ¬¡è¯·æ±‚å·²æ ‡è®°ä¸ºisTimeUp=trueï¼Œå–æ¶ˆç¬¬äºŒæ¬¡è¯·æ±‚`, 'success');
                        isReading = false;
                        timeoutTimer = null;
                        return;
                    }
                    
                    if (messageHistory.length === 0) {
                        addLog(`âŒ æ¶ˆæ¯å†å²å·²è¢«æ¸…ç©ºï¼Œæ— æ³•æ‰§è¡Œç¬¬äºŒæ¬¡è¯·æ±‚`, 'error');
                        isReading = false;
                        timeoutTimer = null;
                        return;
                    }
                    
                    // æ‰§è¡Œç¬¬äºŒæ¬¡è¯·æ±‚
                    addLog(`â° âœ… æ‰§è¡Œç¬¬äºŒæ¬¡è¯·æ±‚`, 'success');
                    isReading = false;
                    isSecondRequest = true;
                    timeoutTimer = null;
                    processMessages(true); // trueè¡¨ç¤ºç¬¬äºŒæ¬¡è¯·æ±‚
                }, delayTime);
            }
            
            // åˆå§‹åŒ–
            addLog('ï¿½ï¿½ è¥é”€æ™ºèƒ½ä½“æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ v2.12', 'info');
            addLog(`âš ï¸ é‡è¦æç¤ºï¼šé˜…è¯»æ—¶é—´å°†ä»ç¬¬ä¸€æ¬¡APIè¯·æ±‚çš„read_timeå˜é‡ä¸­è·å–ï¼Œè¯·ç¡®ä¿å·¥ä½œæµé…ç½®æ­£ç¡®`, 'warning');
            addLog(`ğŸ”§ v2.12ç®€åŒ–ç‰ˆï¼šç§»é™¤æ—¶é—´å’Œæ¶ˆæ¯æ•°é˜ˆå€¼é…ç½®ï¼Œä¸“æ³¨æ ¸å¿ƒåŒè¯·æ±‚é€»è¾‘`, 'success');
        });
    </script>
</body>
</html> 