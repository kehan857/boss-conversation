# FastGPT 多消息汇总功能使用指南

## 功能介绍

多消息汇总功能可以让销售智能体在用户连续发送多条消息时不立即回复，而是等待用户输入完成后再统一回复。这样可以避免打断用户的表达，提供更好的用户体验。

## 工作原理

该功能主要通过判断以下两个条件来决定是否触发回复：

1. **时间间隔阈值**：当用户停止发送消息，间隔时间超过设定阈值（默认5秒）时，触发回复。
2. **消息数量阈值**：当用户连续发送的消息数量达到设定阈值（默认10条）时，立即触发回复。

无论通过哪种方式触发回复，系统都会将用户连续发送的多条消息合并，然后一次性传递给AI进行处理和回复。当触发回复后，消息计数会重置为0，开始下一轮的消息统计。

## 工作流节点说明

### 1. 多消息汇总插件

核心功能实现在这个插件中，它负责：
- 接收用户的每条新消息
- 判断是否应该触发回复
- 管理消息历史和计数
- 合并多条消息

#### 输入参数

| 参数名 | 类型 | 说明 | 默认值 |
|-------|------|------|-------|
| userMessage | 字符串 | 当前新输入的用户消息 | 必填 |
| messageHistory | 数组 | 已缓存的用户消息历史 | [] |
| lastMessageTime | 数字 | 上次消息的时间戳(毫秒) | 0 |
| messageThreshold | 数字 | 触发回复的最大消息数阈值 | 10 |
| timeThreshold | 数字 | 触发回复的时间间隔(毫秒) | 5000 |
| messageCount | 数字 | 当前已累积的消息数量 | 0 |

#### 输出参数

| 参数名 | 类型 | 说明 |
|-------|------|------|
| shouldReply | 布尔值 | 是否应该触发回复 |
| updatedMessageHistory | 数组 | 更新后的消息历史 |
| combinedMessage | 字符串 | 合并后的用户消息内容 |
| lastMessageTime | 数字 | 当前消息的时间戳(毫秒) |
| messageCount | 数字 | 更新后的消息计数 |

### 2. 全局变量

工作流中使用了三个全局变量来维护状态：

- **messageHistory**：缓存用户连续发送的消息
- **lastMessageTime**：记录上一条消息的时间戳
- **messageCount**：记录当前累积的消息数量

### 3. 条件控制节点

根据多消息汇总插件的输出决定是否触发AI回复。

### 4. AI回复节点

当条件满足时，将合并后的消息发送给AI进行处理和回复。

## 配置指南

### 1. 导入工作流

在FastGPT平台中，导入多消息汇总工作流.json文件。

### 2. 调整参数

可以根据实际需求调整以下参数：

- **消息数阈值(messageThreshold)**：当连续消息达到这个数量时立即回复，默认为10条。
- **时间阈值(timeThreshold)**：当用户停止发消息超过这个时间时触发回复，默认为5000毫秒(5秒)。

### 3. 测试工作流

使用多消息汇总测试页面进行测试：
1. 连续快速发送多条消息，看到系统不会立即回复
2. 发送消息后暂停超过5秒，系统应该触发回复
3. 连续发送10条消息，系统应该立即触发回复
4. 触发回复后，消息计数会重置为0，开始新一轮的统计

## 常见问题解答

**Q: 为什么设置了5秒间隔，但系统没有及时回复？**  
A: 请检查全局变量连接是否正确，特别是lastMessageTime的连接。

**Q: 为什么连续发送了10条消息，系统仍未回复？**  
A: 请检查messageCount变量连接是否正确，以及messageThreshold阈值设置。

**Q: 系统回复后，为什么消息历史没有清空？**  
A: 在触发回复时，updatedMessageHistory会被重置为空数组，请检查连接。

**Q: 能否同时保留上下文历史？**  
A: 可以，但需要修改工作流，添加额外的上下文管理节点。当前设计专注于多消息汇总而不保存对话上下文。

## 最佳实践

1. 对于销售场景，建议将时间阈值设置在3-5秒之间，让用户有足够时间组织表达
2. 消息数阈值设置为8-10条比较合理，避免过长的消息累积
3. 可以在系统提示词中告知用户这个功能的存在，如"您可以连续发送多条消息，我会等您表达完整后再回复"

## 本地测试

1. 克隆本项目代码
2. 安装依赖：`npm install express cors http-proxy-middleware`
3. 启动本地服务器：`node proxy_server.js`
4. 访问 `http://localhost:3001/multi_message_test.html` 进行功能测试

## 实现注意事项

1. **持久存储**：多消息汇总功能依赖于对消息历史和时间戳的存储，确保全局变量正确配置。

2. **延迟考量**：插件默认配置适用于大多数场景，但在网络延迟较高的情况下，可能需要适当增加时间阈值。

3. **兼容性**：此功能适用于FastGPT平台，如需应用于其他平台，可能需要调整插件接口和实现方式。

## 适用场景

- 销售机器人与潜在客户的初次咨询对话
- 客户服务场景中客户连续描述问题
- 问卷调查或信息收集场景
- 教育辅导中学生连续提问

通过合理配置多消息汇总功能，可以显著提升用户对话体验，让AI对话更加自然、流畅，更好地理解和满足用户需求。 