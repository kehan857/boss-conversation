# 销售智能体工作流说明文档

## 概述

本工作流是一个智能销售助手系统，主要用于自动化处理客户咨询，提供知识库检索和回复能力，能够处理各种问题类型并给出相应的回复。系统设计为能够识别客户的意图，区分不同类型的问题，并基于客户的对话历史和问题内容提供个性化响应。

## 工作流程图

```
开始
 ↓
延迟等待 (8秒)
 ↓
流程类型判断 (激活/测试/其他)
 ↓
记录对话轮数
 ↓
问题分类（多种类型识别）
 ↓
根据问题类型处理:
 ├── 项目资料请求 → 提取客户对话 → 批量执行(识别项目) → 提供资料
 ├── 项目/大会相关问题 → 知识库搜索 → 智能回复
 ├── 辱骂/骚扰/厌烦 → 负面情绪处理
 └── 肯定回答 → 知识库搜索 → 智能回复
```

## 核心功能模块

### 1. 流程控制与初始化

- **延迟等待**: 系统启动时等待8秒，确保初始化完成
- **流程类型判断**: 区分测试模式和实际激活模式
- **对话计数**: 记录与用户的对话轮数，每次对话+1

### 2. 问题分类系统

系统使用AI模型(gpt-4o-mini)将用户问题分为以下几种类型：

- **要项目相关资料**: 当客户询问是否有资料时
- **聊项目、大会相关内容等**: 涉及行业、项目、大会的问题或其他一般疑问
- **辱骂、骚扰、厌烦**: 客户表现出负面情绪或不友好态度时
- **肯定回答**: 客户简单回复"好"、"可以"等肯定性内容时

### 3. 知识库检索系统

- **语义检索**: 从知识库中查找与用户问题相关的内容
- **相似度阈值**: 设置为0.55，确保返回内容相关性
- **扩展查询**: 使用AI模型(gpt-4o-mini)扩展原始查询以提高检索质量

### 4. 智能回复生成

系统根据不同场景使用不同的回复策略：

#### 有知识库结果时
使用豆包大模型(Doubao-1.5-pro-32k)生成回复，并遵循以下规则：
- 口语化表达方式
- 控制回答在100字以内
- 禁止出现引用提示、客服话术等
- 将"投资"改为"合作"
- 避免使用项目符号和特殊格式

#### 无知识库结果时
提供备选回复，同样使用口语化表达，但不引用知识库内容。

#### 处理负面情绪
特别设计的模块处理客户的辱骂、骚扰或厌烦情绪，使用缓和语气避免矛盾激化。

### 5. 项目资料识别系统

- **批量执行**: 分析客户历史对话，自动识别客户感兴趣的项目
- **提取项目名称**: 使用AI模型从对话中提取关键项目信息
- **资料推送**: 根据识别的项目名称，推送相关资料

### 6. 日期与确认处理

- **日期比较**: 跟踪和比较通知日期与当前日期
- **二次确认**: 当无法确定客户问题中的项目时，会要求客户再次确认项目名称

### 7. 高意向客户处理

系统可以识别并标记高意向客户，通过HTTP请求将这些信息记录下来，用于后续跟进。

## 系统参数设置

### AI模型配置
- 问题分类: gpt-4o-mini
- 内容生成: Doubao-1.5-pro-32k
- 知识库扩展查询: gpt-4o-mini/gpt-4o

### 回复控制
- 回复长度: 控制在100字以内
- 语气: 口语化、友好
- 禁用内容: 引用提示、客服套话、项目符号

### 数据处理
- 对话历史记录: 保存最近10轮对话
- 知识库搜索结果限制: 12900字节
- 知识库相似度阈值: 0.55

## 注意事项

1. 系统会自动将"你"改为"您"，保持礼貌用语
2. 所有项目均会被描述为"我们加速孵化的项目"
3. 系统会避免出现"投资"、"挣钱"、"保本"等敏感词汇
4. 在处理高意向客户时，会记录通知日期，便于后续跟进
5. 当无法确定客户询问的具体项目时，系统会请求客户确认或提出电话联系

## 系统参数传递机制

系统使用多种全局变量在不同节点间传递数据，实现复杂的业务逻辑和状态跟踪。

### 系统全局变量

#### 用户会话变量
- **dialogueCount**：对话轮数计数器，初始值为1，每次对话+1
- **histories**：存储最近10轮对话历史，用于上下文理解
- **userChatInput**：当前用户输入内容，从入口节点获取
- **dialoguesArr**：客户历史对话数组，通过"提取客户对话"节点生成，用于项目名称识别

#### 身份标识变量
- **nickName**：客户昵称，用于个性化回复和HTTP请求
- **accountNo**：用户OAID，作为用户唯一标识符
- **nickId**：用户昵称ID，配合accountNo使用

#### 流程控制变量
- **processType**：流程类型标记
  - "activation"：主动激活模式
  - "test"：测试模式
  - "greet"：问候模式
  - "callBack"：回调模式
- **confirmAgain**：项目名称二次确认标记
  - "0"：初始值/重置值，表示未确认
  - "1"：已向用户请求确认项目名称

#### 业务数据变量
- **projectName**：识别的项目名称
  - 初始值为空字符串
  - 通过"批量执行"分析用户对话提取
  - "0"表示未识别到项目名称
- **noticeDate**：通知日期，记录通知高意向客户的时间
- **currentDate**：当前日期，用于与noticeDate比较
- **sameTime**：日期比较结果
  - "0"：日期不同
  - "1"：日期相同

#### 角色与内容变量
- **role**：AI角色设定，用于AI聊天节点的系统提示

### 核心变量传递流程

#### 1. 对话计数传递
```
工作流开始 → 延迟等待 → 代码运行 → 变量更新(dialogueCount)
```
- 作用：更新dialogueCount全局计数器，每次对话+1
- 传递方式：通过代码节点输出结果更新全局变量
- 输入变量：
  - userChatInput：用户当前输入的内容
  - dialogueCount：当前对话轮数(如果为空则初始化为1)
- 输出变量：
  - dialogueCount：更新后的对话轮数值(原值+1)

#### 2. 问题分类传递
```
问题分类 → 路由到对应处理分支
```
- 作用：根据分类结果路由到不同处理流程
- 传递方式：基于cqResult输出连接到不同目标节点
- 输入变量：
  - userChatInput：用户当前输入的问题
  - history：最近10轮对话历史
  - systemPrompt：分类提示词，包含分类规则
- 输出变量：
  - cqResult：分类结果，可能的值包括"要项目相关资料"、"聊项目、大会相关内容等"、"辱骂、骚扰、厌烦"、"肯定回答"

#### 3. 客户对话提取
```
提取客户对话 → 变量更新 → 批量执行(dialoguesArr)
```
- 作用：提取历史对话内容，构建dialoguesArr数组
- 传递方式：通过代码节点结果更新dialoguesArr全局变量
- 输入变量：
  - histories：系统保存的对话历史记录
  - userChatInput：用户当前输入内容
- 输出变量：
  - dialoguesArr：包含所有用户消息的数组，格式为[message1, message2, ...]，用于后续项目名称识别

#### 4. 项目名称识别
```
批量执行 → 知识库搜索 → 文本内容提取 → 变量更新(projectName)
```
- 作用：从用户对话中提取项目名称
- 传递方式：批量处理对话内容，将识别结果更新到projectName变量
- 输入变量：
  - dialoguesArr：包含用户历史消息的数组
  - loopStartInput：每次循环处理的单条对话内容
- 输出变量：
  - projectName：识别出的项目名称
    - 有效值：对应识别出的具体项目名称(如"漂亮妈妈")
    - "0"：表示未能识别出有效项目名称

#### 5. 知识库检索传递
```
知识库搜索 → 判断器 → AI聊天(quoteQA)
```
- 作用：检索知识库内容，通过quoteQA传递搜索结果
- 传递方式：quoteQA直接传入AI聊天节点作为引用内容
- 输入变量：
  - userChatInput：用户问题内容
  - datasets：需要检索的知识库ID集合
  - similarity：相似度阈值(0.55)
  - searchMode：搜索模式("embedding")
- 输出变量：
  - quoteQA：知识库搜索结果，包含问答对数组，格式为[{id, datasetId, q, a}, ...]
  - ifElseResult：判断结果，用于路由到有结果/无结果处理流程

#### 6. 日期比较逻辑
```
获取当前日期 → 变量更新(currentDate) → 代码运行比较 → 变量更新(sameTime)
```
- 作用：比较noticeDate与currentDate是否相同
- 传递方式：通过代码节点计算结果更新sameTime变量
- 输入变量：
  - noticeDate：记录的通知日期，格式为"YYYY-MM-DD"
  - currentDate：当前系统日期，格式为"YYYY-MM-DD"
- 输出变量：
  - sameTime：比较结果
    - "1"：日期相同
    - "0"：日期不同
  - ifElseResult：基于sameTime的判断结果，用于决定是否需要执行高意向客户通知

### 条件判断参数传递

#### 流程类型判断
- 判断节点：`lzWFvVzSC9LK`
- 判断条件：
  ```
  IF: processType == "activation" || processType == "greet" || processType == "callBack"
  ELSE IF: processType == "test"
  ELSE: 其他情况
  ```

#### 知识库结果判断
- 判断节点：`ivmHqG9kkBrT`
- 判断条件：
  ```
  IF: quoteQA 不为空
  ELSE: quoteQA 为空
  ```

#### 项目名称识别判断
- 判断节点：`ihqM5pk7kYAW`
- 判断条件：
  ```
  IF: projectName == "0"
  ELSE IF: projectName 不为空 且 projectName != "0"
  ```

#### 二次确认判断
- 判断节点：`rwg5bEtZ9SgQ`
- 判断条件：
  ```
  IF: confirmAgain == "0"
  ELSE: confirmAgain != "0"
  ```

### HTTP请求参数传递

系统中包含两类重要的HTTP请求：

#### 高意向客户记录
- 节点：`c0bYEbxvrcCk`
- 参数传递：
  ```json
  {
    "user": "{{accountNo}}",
    "nickName": "{{nickName}}",
    "nickId": "{{nickId}}"
  }
  ```

#### 负面情绪记录
- 节点：`vayWGgFNEx7q`
- 参数传递：
  ```json
  {
    "user": "{{accountNo}}",
    "nickName": "{{nickName}}",
    "nickId": "{{nickId}}"
  }
  ```

### 综合应用场景

1. **高意向客户处理**
   - 记录通知日期(noticeDate)
   - 比较当前日期(currentDate)
   - 根据比较结果(sameTime)决定是否重复通知

2. **项目资料请求场景**
   - 提取对话历史(dialoguesArr)
   - 批量识别项目名称(projectName)
   - 基于识别结果决定是否需要二次确认(confirmAgain)

3. **负面情绪处理**
   - 问题分类识别负面情绪
   - 记录负面情绪情况
   - 使用专门的回复策略处理

4. **知识库应用场景**
   - 基于用户问题检索知识库
   - 判断是否有匹配结果
   - 根据结果选择不同回复生成策略

通过以上参数传递机制，销售智能体能够在各种复杂场景下保持状态连续性，实现个性化、上下文相关的智能回复。

## 总结

该销售智能体工作流是一个全面的客户咨询处理系统，通过AI技术智能识别客户意图，结合知识库内容提供精准回复，并能妥善处理各种交互场景，包括资料需求、项目咨询、负面情绪等。系统设计注重用语规范，确保回复专业、简洁且富有人情味，为销售流程提供强大的自动化支持。 