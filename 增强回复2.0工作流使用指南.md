# 增强回复2.0工作流使用指南

本文档提供了如何改造增强回复2.0版本工作流，使其支持多消息处理和分段输出功能的详细说明。

## 1. 改造思路

增强回复2.0版本工作流改造的核心思路是：

1. 添加消息等待机制，控制连续发送消息时的回复触发逻辑
2. 实现增强回复分段器，将长文本按句子切分并添加表情
3. 通过工作流中的条件路由控制是否应该回复
4. 在对话输出节点通过shouldReply控制是否显示回复

这种改造方式无需修改现有的营销智能体三期内容融合版本，可以作为一个独立的工作流部署。

## 2. 文件结构

改造后的工作流包含以下核心文件：

- `FastGPT消息等待工具.js`：实现多消息处理的等待逻辑
- `FastGPT增强回复分段输出节点.js`：实现增强回复文本分段和格式化
- `增强回复2.0工作流.json`：完整的工作流定义，包含节点和连接关系
- `增强回复2.0测试页面.html`：用于测试工作流的前端页面

## 3. 消息等待机制

消息等待工具实现了以下功能：

- 跟踪用户连续发送的消息，维护消息历史记录
- 根据消息数量阈值和时间阈值决定何时触发回复
- 记录对话状态，如上次消息时间、消息计数、对话轮次等
- 输出shouldReply标志，控制是否显示AI回复

关键参数：

- `messageThreshold`：触发回复的消息数量阈值（默认3条）
- `timeThreshold`：触发回复的时间阈值（默认2000毫秒）

## 4. 增强回复分段器

增强回复分段器实现了以下功能：

- 接收大模型生成的长文本，并按句子边界进行切分
- 为每段文本添加随机表情，提升可读性
- 支持自定义分段长度和延迟时间
- 输出分段文本数组和延迟时间

关键参数：

- `segmentLength`：每段文本的最大字符数（默认50字符）
- `accumulatedDelay`：每段显示的延迟时间（默认2000毫秒）

## 5. 使用方法

### 5.1 FastGPT工作流部署

1. 在FastGPT中创建一个新的工作流
2. 使用代码执行节点创建消息等待工具和增强回复分段器
3. 上传或复制`增强回复2.0工作流.json`内容导入工作流
4. 配置工作流各节点的参数，特别是消息等待工具的阈值参数
5. 发布工作流并获取API访问凭证

### 5.2 测试页面使用

1. 部署`增强回复2.0测试页面.html`到Web服务器，或通过浏览器直接打开
2. 在页面配置面板填写正确的API地址和应用ID
3. 配置消息阈值和时间阈值
4. 开始发送消息测试

## 6. 工作流流程说明

整个工作流的执行流程如下：

1. 用户发送消息，进入消息等待工具节点
2. 消息等待工具检查是否满足回复条件
   - 是首次对话：立即回复
   - 达到消息数阈值：回复并清空历史
   - 达到时间阈值：回复并清空历史
   - 不满足任何条件：不回复，保存消息
3. 条件路由根据shouldReply控制流程走向
4. 如需回复，调用大模型生成回复内容
5. 增强回复分段器将回复内容切分并格式化
6. 对话输出节点将分段内容按延迟时间显示出来

## 7. 测试建议

测试时可以尝试以下场景：

1. **首次对话测试**：第一次发送消息，应立即回复
2. **连续发送测试**：快速连续发送小于阈值数量的消息，应不显示中间回复
3. **达到阈值测试**：发送达到阈值数量的消息，应触发回复
4. **等待超时测试**：发送消息后等待超过时间阈值，应触发回复
5. **分段输出测试**：观察长回复是否正确分段，表情是否正确添加

## 8. 常见问题

### 8.1 消息未按预期等待

可能原因：
- 消息阈值或时间阈值设置不合理
- 工作流节点连接错误

解决方法：
- 检查消息等待工具的参数配置
- 确认工作流中shouldReply连接到了对话输出节点

### 8.2 分段输出未正确显示

可能原因：
- 增强回复分段器未正确解析文本
- 前端页面未正确处理分段数组

解决方法：
- 检查增强回复分段器的代码实现
- 查看API响应中是否包含正确的outputText数组

## 9. 进阶定制

如需进一步定制增强回复2.0工作流，可以考虑：

1. 优化分段算法，支持更复杂的内容格式（如列表、表格等）
2. 增加更丰富的表情库和格式化规则
3. 实现更智能的等待策略，如根据消息长度或内容类型动态调整
4. 增加用户意图识别，针对特定意图优先响应

## 10. 结语

通过本指南的步骤，你可以成功改造增强回复2.0版本工作流，实现多消息处理和分段输出功能。这种改造不仅提升了用户体验，还使对话看起来更像真人交流。 