# FastGPT多消息汇总功能使用指南

## 功能介绍

多消息汇总功能可以在短时间内汇总用户连续发送的多条消息，避免AI在用户表达未完成时就开始回复，从而提升用户体验。

当满足以下条件之一时，系统会自动触发AI回复：
1. 用户停顿超过设定时间（默认5秒）
2. 消息数量超过设定阈值（默认10条）

## 实现方式

FastGPT提供两种实现方式：

### 方式一：使用代码运行节点

这种方式更加灵活，可以直接在工作流中配置，无需上传插件。

1. 在工作流编辑器中添加代码运行节点
2. 将本文档提供的代码复制到代码运行节点中
3. 配置判断器节点和工作流连接

### 方式二：使用插件

1. 创建插件并上传本文档提供的插件文件
2. 在工作流中添加插件调用节点
3. 配置工作流连接

## 代码运行节点配置说明

### 输入参数

代码运行节点接受以下输入参数：

- `userChatInput`：用户当前输入的消息（必填）
- `timeThreshold`：触发回复的时间阈值，单位毫秒，默认5000毫秒
- `messageThreshold`：触发回复的消息数阈值，默认10条
- `maxDialogTurns`：最大对话轮次，超过该值后重置计数器，默认10轮

### 输出参数

代码运行节点会返回以下输出参数：

- `userChatInput`：处理后的用户输入（合并后的消息或原始消息）
- `shouldReply`：是否应该触发AI回复
- `shouldBlock`：是否应该阻止工作流继续执行
- `messageCount`：更新后的消息计数
- `dialogTurns`：当前对话轮次
- `timeSinceLastMessage`：距离上次消息的时间间隔
- `messagesInHistory`：历史消息数量

### 全局变量

代码运行节点使用以下全局变量存储状态：

- `global.lastMessageTime`：上次消息的时间戳
- `global.messageHistory`：消息历史数组
- `global.messageCount`：当前消息计数
- `global.dialogTurns`：当前对话轮次

## 工作流配置步骤

1. **添加用户输入节点**
   - 设置：启用流式输出

2. **添加代码运行节点**
   - 复制本文档提供的代码
   - 输入参数：`userChatInput` 连接到用户输入节点的输出

3. **添加判断器节点**
   - 判断条件：`{{outputs.代码运行节点.shouldReply}}`
   - 为真：连接到AI回复节点
   - 为假：连接到工作流结束节点

4. **添加AI回复节点**
   - 输入：`{{outputs.代码运行节点.userChatInput}}`
   - 模型：根据需要选择

5. **添加结束节点**
   - 连接到判断器节点的"为假"分支

## 常见问题

### Q: 为什么我的消息没有被汇总？
A: 请检查时间阈值设置，默认为5秒，可能需要根据用户输入习惯调整。

### Q: 如何修改默认参数？
A: 在代码运行节点中直接修改默认值，或通过工作流变量传入自定义参数。

### Q: 全局变量是否会影响其他会话？
A: 不会，FastGPT的全局变量是会话级别的，不同会话之间相互独立。 